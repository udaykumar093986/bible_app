<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — Fast Minimal</title>

<style>
  :root{--bg:#fff;--card:#fff;--muted:#233;--accent:#0b66c2;--border:#e9eef6}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial; background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
  .top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);z-index:10}
  .brand{font-weight:700;color:var(--accent)}
  main{max-width:980px;margin:14px auto;padding:0 14px}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  select,input{padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff}
  button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .reader{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);min-height:220px}
  .ref{font-weight:700;color:var(--accent);margin-bottom:10px}
  .verse{padding:10px;border-radius:10px;margin-bottom:8px;background:#f8fbff;border:1px solid var(--border)}
  .verse .num{font-weight:700;color:#567;text-transform:uppercase;font-size:12px;margin-bottom:6px}
  .search-results{margin-top:8px}
  .search-item{padding:10px;border-radius:10px;background:#fff;border:1px solid var(--border);margin-bottom:8px;cursor:pointer}
  .search-item small{color:#556;display:block;margin-top:6px}
  @media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} button{width:100%} select,input{width:100%} }
</style>
</head>
<body>

<header class="top">
  <div class="brand">Bible Reader (Fast)</div>
  <div style="font-size:13px;color:#5a6">Option C — Ultra-fast</div>
</header>

<main>
  <div class="controls" role="toolbar" aria-label="controls">
    <select id="versionSelect" aria-label="Version">
      <option value="">Select version</option>
    </select>

    <button id="openRead">Open default</button>

    <input id="searchBox" placeholder="Search (select version first)" aria-label="Search" />
    <button id="searchBtn">Search</button>
  </div>

  <section>
    <div class="reader" id="reader">
      <div id="currentRef" class="ref">Select a version → Open a chapter</div>
      <div id="versesContainer"></div>
    </div>

    <div id="searchContainer" style="margin-top:14px">
      <div id="searchInfo" style="color:#556;font-size:13px;margin-bottom:8px"></div>
      <div id="searchResults" class="search-results"></div>
    </div>
  </section>
</main>

<script>
(async function(){

/* -------- CONFIG (matches your repo filenames) -------- */
const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/"; // root of your repo
const FILES = [
  "AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json","NIV_bible.json",
  "NKJV_bible.json","NLT_bible.json","afrikaans_bible.json","bengali_bible.json","gujarati_bible.json",
  "hindi_bible.json","hungarian_bible.json","indonesian_bible.json","kannada_bible.json","malayalam_bible.json",
  "marathi_bible.json","nepali_bible.json","odia_bible.json","punjabi_bible.json","sepedi_bible.json",
  "tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
];

/* ---- state/cache ---- */
const versionMap = {};      // label -> filename
const bibleCache = {};      // label -> normalized data (books, chapters)
const searchIndex = {};     // label -> flattened [{book, chapter, verse, textLower, text}]
let current = { version: null, bookIndex: 0, chapterIndex: 0 };

/* ---- dom ---- */
const versionSelect = document.getElementById('versionSelect');
const openRead = document.getElementById('openRead');
const searchBox = document.getElementById('searchBox');
const searchBtn = document.getElementById('searchBtn');
const reader = document.getElementById('reader');
const versesContainer = document.getElementById('versesContainer');
const currentRef = document.getElementById('currentRef');
const searchResults = document.getElementById('searchResults');
const searchInfo = document.getElementById('searchInfo');

/* ---- populate version selector ---- */
function buildLabel(fn){
  // produce readable label from filename: KJV_bible.json -> KJV
  return fn.replace(/_bible\.json$/i,'').replace(/\.json$/i,'');
}
FILES.forEach(fn=>{
  const label = buildLabel(fn);
  versionMap[label] = fn;
  const opt = document.createElement('option');
  opt.value = label; opt.textContent = label;
  versionSelect.appendChild(opt);
});

/* ---- helpers ---- */
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* normalize shapes (similar to your original) */
function normalize(data){
  const out={books:[]};
  if(Array.isArray(data.books)){
    out.books = data.books.map(b=>({
      name: b.name || b.book || 'Unknown',
      chapters: (b.chapters||[]).map(c=>Array.isArray(c)?c:Object.values(c||{}))
    }));
    return out;
  }
  for(const bk of Object.keys(data||{})){
    const bookObj = data[bk];
    const chapters = [];
    if(bookObj && Array.isArray(bookObj.chapters)){
      for(const c of bookObj.chapters) chapters.push(Array.isArray(c)?c:Object.values(c||{}));
    } else {
      const keys = Object.keys(bookObj||{}).sort((a,b)=>Number(a)-Number(b));
      for(const k of keys){
        const ch = bookObj[k];
        if(Array.isArray(ch)) chapters.push(ch);
        else if(typeof ch==='object') chapters.push(Object.keys(ch).sort((a,b)=>Number(a)-Number(b)).map(vk=>ch[vk]));
        else chapters.push([String(ch)]);
      }
    }
    out.books.push({name:bk,chapters});
  }
  return out;
}

/* ---- load version JSON and build small search index ---- */
async function loadVersion(label){
  if(!label) throw new Error("No label");
  if(bibleCache[label]) return bibleCache[label];
  const filename = versionMap[label];
  const url = BASE + filename;
  try{
    showTempNotice('Loading ' + label + ' …');
    const res = await fetch(url);
    if(!res.ok) throw new Error('Failed to fetch ' + url);
    const j = await res.json();
    const norm = normalize(j);
    bibleCache[label] = norm;
    buildIndexForVersion(label, norm);
    hideTempNotice();
    return norm;
  }catch(err){
    hideTempNotice();
    showTempNotice('Load failed: ' + (err.message||err), 3000);
    throw err;
  }
}

/* build flattened index for faster searching */
function buildIndexForVersion(label, norm){
  const idx = [];
  norm.books.forEach((b,bi)=>{
    b.chapters.forEach((ch,ci)=>{
      ch.forEach((v,vi)=>{
        const text = (v||'').toString();
        idx.push({
          bookIndex: bi,
          chapterIndex: ci,
          verseIndex: vi,
          book: b.name,
          chapter: ci+1,
          verse: vi+1,
          text,
          textLower: text.toLowerCase()
        });
      });
    });
  });
  searchIndex[label] = idx;
}

/* ---- render a chapter ---- */
function renderChapter(){
  const v = current.version;
  if(!v || !bibleCache[v]){ versesContainer.innerHTML = '<div style="padding:12px">Select a version and open a chapter</div>'; currentRef.textContent='—'; return; }
  const book = bibleCache[v].books[current.bookIndex];
  const chap = book.chapters[current.chapterIndex] || [];
  currentRef.textContent = `${book.name} ${current.chapterIndex + 1}`;
  let html = '';
  for(let i=0;i<chap.length;i++){
    html += `<div class="verse"><div class="num">Verse ${i+1}</div><div>${escapeHtml(chap[i])}</div></div>`;
  }
  versesContainer.innerHTML = html || '<div style="padding:12px">No verses found</div>';
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ---- simple UI helpers ---- */
let tempNoticeEl = null;
function showTempNotice(msg,ms=0){
  if(!tempNoticeEl){
    tempNoticeEl = document.createElement('div');
    tempNoticeEl.style.position='fixed';
    tempNoticeEl.style.left='10px';
    tempNoticeEl.style.right='10px';
    tempNoticeEl.style.top='72px';
    tempNoticeEl.style.padding='10px';
    tempNoticeEl.style.borderRadius='8px';
    tempNoticeEl.style.textAlign='center';
    tempNoticeEl.style.zIndex='999';
    tempNoticeEl.style.background = '#fff8';
    tempNoticeEl.style.border='1px solid #eee';
    document.body.appendChild(tempNoticeEl);
  }
  tempNoticeEl.textContent = msg;
  tempNoticeEl.style.display = '';
  if(ms>0) setTimeout(()=>tempNoticeEl.style.display='none', ms);
}
function hideTempNotice(){ if(tempNoticeEl) tempNoticeEl.style.display='none'; }

/* ---- search (uses prebuilt index) ---- */
async function runSearch(query){
  query = (query||'').trim().toLowerCase();
  searchResults.innerHTML = ''; searchInfo.textContent = '';
  if(!query) return;
  if(!current.version){
    searchInfo.textContent = 'Please select a version first';
    return;
  }
  // ensure version loaded
  if(!searchIndex[current.version]) {
    await loadVersion(current.version);
  }
  const idx = searchIndex[current.version];
  if(!idx) { searchInfo.textContent = 'No index available'; return; }

  const results = [];
  // use simple substring search on pre-lowercased values; gather up to maxResults
  const maxResults = 150;
  for(let i=0;i<idx.length && results.length < maxResults;i++){
    if(idx[i].textLower.includes(query)) results.push(idx[i]);
  }

  searchInfo.textContent = `Found ${results.length}${results.length>=maxResults ? ' (showing first '+maxResults+')':''}`;
  if(!results.length){ searchResults.innerHTML = '<div style="padding:8px;color:#666">No results</div>'; return; }

  // render
  const frag = document.createDocumentFragment();
  results.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'search-item';
    div.innerHTML = `<strong>${escapeHtml(r.book)} ${r.chapter}:${r.verse}</strong>
                     <div style="margin-top:6px">${escapeHtml(r.text.length>280 ? r.text.slice(0,280)+'…': r.text)}</div>
                     <small>Click to open chapter</small>`;
    div.onclick = async ()=>{
      // open the chapter containing this result
      current.bookIndex = r.bookIndex;
      current.chapterIndex = r.chapterIndex;
      // ensure data loaded (already is)
      renderChapter();
      window.scrollTo({top: document.getElementById('reader').offsetTop, behavior:'smooth'});
    };
    frag.appendChild(div);
  });
  searchResults.appendChild(frag);
}

/* ---- UI events ---- */
versionSelect.onchange = async function(){
  const label = versionSelect.value;
  if(!label) return;
  current.version = label;
  // quick auto-load meta + index (async)
  try{ await loadVersion(label); showTempNotice(label + ' ready', 800); } catch(e){ console.error(e); }
};

openRead.onclick = async function(){
  if(!current.version){
    showTempNotice('Please select a version first',1500);
    return;
  }
  // open book 0, chapter 0 by default
  current.bookIndex = 0; current.chapterIndex = 0;
  await loadVersion(current.version);
  renderChapter();
};

searchBtn.onclick = function(){ runSearch(searchBox.value); };
searchBox.onkeydown = function(e){ if(e.key === 'Enter'){ runSearch(searchBox.value); } };

/* ---- initialize: set small default and keep UI minimal ---- */
(function init(){
  // choose a default version if you want, or leave blank
  // versionSelect.value = 'KJV'; current.version = 'KJV';
  versesContainer.innerHTML = '<div style="padding:12px">Select a version from the dropdown and click "Open default" or Search</div>';
})();

})();
</script>
</body>
</html>

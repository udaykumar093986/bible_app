<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — Index</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#f7f9fc;--accent:#0b66c2;--border:#e2e8f0;--highlight:#fff3c4;--pulse:#ffda6b}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{background:var(--bg);color:#1d2d35;-webkit-font-smoothing:antialiased}
header{padding:14px 20px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.header .brand{font-size:20px;font-weight:700;color:var(--accent)}
main{max-width:960px;margin:20px auto;padding:0 18px}
.controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:14px}
select,input{padding:12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:14px;min-width:140px}
button{border:0;background:var(--accent);color:#fff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px}
.jump-container{background:white;border-radius:12px;border:1px solid var(--border);margin-bottom:18px;overflow:hidden}
.jump-header{padding:14px 16px;background:#f4f8ff;cursor:pointer;font-weight:700;color:var(--accent)}
.jump-body{display:none;padding:14px;background:#fff}
.jump-body select{min-width:140px;margin-right:8px;padding:10px;border-radius:8px;border:1px solid var(--border)}
.jump-body input.range{min-width:160px;padding:10px;border-radius:8px;border:1px solid var(--border);margin-right:8px}
.reader{background:white;border-radius:12px;border:1px solid var(--border);padding:18px;margin-bottom:20px}
.ref{font-size:22px;font-weight:700;color:var(--accent);margin-bottom:16px}
.verse-block{padding:14px;background:#f8fbff;border-radius:12px;border:1px solid var(--border);margin-bottom:14px;transition:0.25s;cursor:pointer}
.verse-num{font-size:13px;font-weight:700;color:#345;margin-bottom:6px}
.verse-primary{font-family:"Noto Serif",serif;font-size:18px;line-height:1.75;color:#111}
.verse-parallel{margin-top:10px;padding-left:14px;border-left:3px solid var(--accent);font-family:"Noto Serif",serif;font-size:17px;color:#2a3c55}
.active-verse{background:#fff8d1 !important;border-color:#ffd56b !important;animation:pulseAnim 1.4s infinite ease-in-out}
@keyframes pulseAnim{0%{box-shadow:0 0 0px var(--pulse)}50%{box-shadow:0 0 12px var(--pulse)}100%{box-shadow:0 0 0px var(--pulse)}}
.notice{position:fixed;top:70px;left:20px;right:20px;padding:12px;border-radius:10px;background:white;border:1px solid var(--border);text-align:center;display:none;z-index:200}
@media(max-width:600px){.controls select,input{width:100%}.jump-body select{width:100%;margin-bottom:8px}.jump-body{display:block}}
</style>
</head>
<body>
<header>
  <div class="brand">Bible Reader</div>
  <div class="meta">Parallel • Search • Deep links</div>
</header>

<main>
  <div class="controls">
    <select id="primarySelect"><option value="">PRIMARY VERSION</option></select>
    <select id="parallelSelect"><option value="">PARALLEL VERSION</option></select>
    <button id="openBtn">Open</button>
    <input id="searchBox" placeholder="Search Text…" style="min-width:200px" />
    <button id="searchBtn">Search</button>
  </div>

  <div class="jump-container">
    <div class="jump-header" id="jumpToggle">▼ Jump to Book / Chapter / Verse</div>
    <div class="jump-body" id="jumpBody" aria-hidden="true">
      <select id="bookSelect"><option value="">Book</option></select>
      <select id="chapterSelect"><option value="">Chapter</option></select>
      <select id="verseSelect"><option value="">Verse</option></select>
      <input id="verseRange" class="range" placeholder="Verse or range (e.g. 7 or 7-8)" />
      <button id="jumpGo">Go</button>
    </div>
  </div>

  <div class="reader">
    <div id="currentRef" class="ref"></div>
    <div id="versesContainer"></div>
  </div>

  <div id="searchInfo" style="margin-bottom:6px;color:#666"></div>
  <div id="searchResults"></div>
</main>

<div id="notice" class="notice" role="status" aria-live="polite"></div>

<script>
(async function(){
  const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";
  const FILES = [
    "telugu_bible.json","KJV_bible.json","NIV_bible.json","ESV_bible.json"
  ];

  // DOM
  const primarySelect = document.getElementById('primarySelect');
  const parallelSelect = document.getElementById('parallelSelect');
  const openBtn = document.getElementById('openBtn');
  const bookSelect = document.getElementById('bookSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const verseSelect = document.getElementById('verseSelect');
  const verseRange = document.getElementById('verseRange');
  const jumpToggle = document.getElementById('jumpToggle');
  const jumpBody = document.getElementById('jumpBody');
  const jumpGo = document.getElementById('jumpGo');
  const currentRef = document.getElementById('currentRef');
  const versesContainer = document.getElementById('versesContainer');
  const searchBox = document.getElementById('searchBox');
  const searchBtn = document.getElementById('searchBtn');
  const notice = document.getElementById('notice');
  const searchResults = document.getElementById('searchResults');
  const searchInfo = document.getElementById('searchInfo');

  const versionMap = {};
  const bibleRawCache = {};
  const bibleNormCache = {};
  const searchIndexCache = {};

  let current = { version: null, parallel: null, book: 0, chapter: 0, singleVerseMode: false, singleVerseIndex: null };

  // populate versions
  FILES.forEach(fn => {
    const label = fn.replace('.json','');
    versionMap[label] = fn;
    primarySelect.appendChild(new Option(label,label));
    parallelSelect.appendChild(new Option(label,label));
  });

  function esc(s){ return (s===undefined || s===null) ? "" : s.toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function showNotice(msg,ms=1400){ notice.textContent = msg; notice.style.display = 'block'; setTimeout(()=> notice.style.display='none', ms); }

  // Sorting helper for verse keys: treat "7-8" by numeric start
  function sortVerseKeys(keys){
    return keys.sort((a,b)=>{
      const pa = parseInt(String(a).split('-')[0],10) || 0;
      const pb = parseInt(String(b).split('-')[0],10) || 0;
      return pa - pb;
    });
  }

  // Normalizer: produce .books[].chapters[][] where each verse is {key,text}
  function normalize(json){
    if(!json) return {books:[]};
    if(json.books && Array.isArray(json.books)){
      // preserve existing structure loosely
      return { books: json.books.map(b => ({
        name: b.name || b.book || "Unknown",
        chapters: (b.chapters || []).map(ch => {
          if(Array.isArray(ch)) return ch.map((t,i)=> ({key: String(i+1), text: t}));
          if(typeof ch === 'object') {
            const vkeys = sortVerseKeys(Object.keys(ch||{}));
            return vkeys.map(k => ({ key: k, text: ch[k] }));
          }
          return [];
        })
      }))};
    }

    // object keyed by bookName
    const books = [];
    for(const bookName of Object.keys(json || {})){
      const bookObj = json[bookName];
      if(!bookObj || typeof bookObj !== 'object') continue;
      const chKeys = Object.keys(bookObj).sort((a,b)=> Number(a)-Number(b));
      const chapters = [];
      for(const ck of chKeys){
        const ch = bookObj[ck];
        if(!ch || typeof ch !== 'object'){ chapters.push([]); continue; }
        const vkeys = sortVerseKeys(Object.keys(ch));
        const verses = vkeys.map(k => ({ key: k, text: ch[k] }));
        chapters.push(verses);
      }
      books.push({ name: bookName, chapters });
    }
    return { books };
  }

  async function fetchAndNormalize(label){
    if(bibleNormCache[label]) return bibleNormCache[label];
    const url = BASE + versionMap[label];
    const res = await fetch(url);
    if(!res.ok) throw new Error("Fetch failed " + res.status);
    const j = await res.json();
    bibleRawCache[label] = j;
    const norm = normalize(j);
    bibleNormCache[label] = norm;
    buildSearchIndex(label, norm);
    return norm;
  }

  function buildSearchIndex(label, norm){
    const idx = [];
    norm.books.forEach((b,bi)=>{
      b.chapters.forEach((ch,ci)=>{
        ch.forEach((v,vi)=>{
          const t = (v && v.text) ? v.text.toString() : "";
          idx.push({bookIndex:bi, chapterIndex:ci, verseIndex:vi, book:b.name, chapter:ci+1, verseKey:v.key, text:t, low:t.toLowerCase()});
        });
      });
    });
    searchIndexCache[label] = idx;
  }

  // Render logic that uses verse.key (supports "7-8")
  function renderChapter(){
    if(!current.version || !bibleNormCache[current.version]){ versesContainer.innerHTML = "<div style='padding:12px'>Select a version and open.</div>"; currentRef.textContent = ""; return; }
    const bookObj = bibleNormCache[current.version].books[current.book];
    const primaryChap = bookObj.chapters[current.chapter] || [];
    let parallelChap = null;
    if(current.parallel && bibleNormCache[current.parallel]){
      const pb = bibleNormCache[current.parallel].books[current.book];
      parallelChap = pb ? (pb.chapters[current.chapter] || []) : null;
    }

    // If singleVerseMode show that verse (single index)
    if(current.singleVerseMode && Number.isInteger(current.singleVerseIndex)){
      const i = current.singleVerseIndex;
      const verseObj = primaryChap[i] || {key: String(i+1), text: ""};
      const prim = esc(verseObj.text);
      const parObj = parallelChap ? (parallelChap.find(v=>v.key===verseObj.key) || {}) : {};
      currentRef.textContent = `${bookObj.name} ${current.chapter + 1}:${verseObj.key}`;
      versesContainer.innerHTML = `<div class="verse-block active-verse" id="v-${i}" data-key="${verseObj.key}">
        <div class="verse-num">Verse ${verseObj.key}</div>
        <div class="verse-primary">${prim}</div>
        ${ parObj.text ? `<div class="verse-parallel">${esc(parObj.text)}</div>` : "" }
      </div>`;
      // click to open read.html in new tab at this verse
      const el = versesContainer.querySelector('.verse-block');
      if(el) el.onclick = () => {
        const params = new URLSearchParams();
        params.set('version', current.version);
        params.set('bookIndex', current.book);
        params.set('chapter', current.chapter + 1);
        params.set('verse', verseObj.key);
        window.open('read.html?' + params.toString(), '_blank');
      };
      return;
    }

    // Range input handling
    const rangeSpec = parseVerseSpecifier(verseRange.value || "", primaryChap.length);
    if(rangeSpec){
      const {start,end} = rangeSpec;
      const keys = primaryChap.slice(start,end+1).map(v=>v.key).join('-');
      const combined = primaryChap.slice(start,end+1).map(v=>v.text).join(' ');
      const parCombined = parallelChap ? parallelChap.slice(start,end+1).map(v=>v.text).join(' ') : "";
      currentRef.textContent = `${bookObj.name} ${current.chapter + 1} — Verses ${primaryChap[start].key}${start!==end?('-'+primaryChap[end].key):''}`;
      versesContainer.innerHTML = `<div class="verse-block active-verse" id="v-range" data-key="${primaryChap[start].key}">
        <div class="verse-num">Verse ${primaryChap[start].key}${start!==end?(' - '+primaryChap[end].key):''}</div>
        <div class="verse-primary">${esc(combined)}</div>
        ${ parCombined ? `<div class="verse-parallel">${esc(parCombined)}</div>` : "" }
      </div>`;
      const el = document.getElementById('v-range');
      if(el) el.onclick = () => {
        const params = new URLSearchParams();
        params.set('version', current.version);
        params.set('bookIndex', current.book);
        params.set('chapter', current.chapter + 1);
        // set verse param to the exact user range (keeps 7-8)
        params.set('verse', verseRange.value.trim());
        window.open('read.html?' + params.toString(), '_blank');
      };
      return;
    }

    // Default: full chapter render
    currentRef.textContent = `${bookObj.name} ${current.chapter + 1}` + (current.parallel ? ` — ${current.parallel}` : "");
    let html = "";
    for(let i=0;i<primaryChap.length;i++){
      const verseObj = primaryChap[i];
      const key = verseObj.key;
      const prim = esc(verseObj.text || "");
      let par = "";
      if(parallelChap){
        const match = parallelChap.find(v => v.key === key);
        if(match) par = esc(match.text || "");
      }
      html += `<div class="verse-block" id="v-${i}" data-vi="${i}" data-key="${key}">
        <div class="verse-num">Verse ${key}</div>
        <div class="verse-primary">${prim}</div>
        ${ par ? `<div class="verse-parallel">${par}</div>` : "" }
      </div>`;
    }
    versesContainer.innerHTML = html || "<div style='padding:12px'>No verses</div>";

    // attach click handlers to each verse: open read.html in new tab with verse param equal to verse.key
    document.querySelectorAll('.verse-block').forEach(el=>{
      const key = el.getAttribute('data-key');
      el.onclick = () => {
        const params = new URLSearchParams();
        params.set('version', current.version);
        params.set('bookIndex', current.book);
        params.set('chapter', current.chapter + 1);
        params.set('verse', key);
        window.open('read.html?' + params.toString(), '_blank');
      };
    });
  }

  // parse user range like "7" or "7-8"
  function parseVerseSpecifier(input, chapterLength){
    if(!input) return null;
    const s = input.trim();
    const m = s.match(/^(\d+)\s*-\s*(\d+)$/);
    if(m){
      const a = Math.max(1, Number(m[1]));
      const b = Math.max(1, Number(m[2]));
      const start = Math.min(a,b)-1;
      const end = Math.max(a,b)-1;
      return { start: Math.max(0, Math.min(start, chapterLength-1)), end: Math.max(0, Math.min(end, chapterLength-1)) };
    }
    const n = Number(s);
    if(!isNaN(n) && n>=1) {
      const idx = Math.max(0, Math.min(n-1, chapterLength-1));
      return {start: idx, end: idx};
    }
    return null;
  }

  // run search
  async function runSearch(){
    const q = (searchBox.value || '').trim().toLowerCase();
    searchResults.innerHTML = ''; searchInfo.textContent = '';
    if(!q) return;
    if(!current.version){ searchInfo.textContent = 'Select primary version first'; return; }
    if(!searchIndexCache[current.version]) await fetchAndNormalize(current.version);
    const idx = searchIndexCache[current.version] || [];
    const results = [];
    for(let i=0;i<idx.length && results.length < 200; i++){
      if(idx[i].low.includes(q)) results.push(idx[i]);
    }
    searchInfo.textContent = `Found ${results.length}`;
    if(!results.length){ searchResults.innerHTML = '<div style="padding:8px;color:#666">No results</div>'; return; }
    const safe = q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const re = new RegExp(safe,'ig');
    const frag = document.createDocumentFragment();
    results.forEach(r => {
      const div = document.createElement('div');
      div.className = 'search-item';
      const primarySnippet = esc(r.text).replace(re, m=>`<span style="background:var(--highlight);padding:2px">${m}</span>`);
      div.innerHTML = `<strong>${esc(r.book)} ${r.chapter}:${r.verseKey}</strong><div style="margin-top:6px">${primarySnippet}</div><small style="display:block;margin-top:6px;color:#666">Click to open</small>`;
      div.onclick = () => {
        const params = new URLSearchParams();
        params.set('version', current.version);
        params.set('bookIndex', r.bookIndex);
        params.set('chapter', r.chapter);
        params.set('verse', r.verseKey);
        window.open('read.html?' + params.toString(), '_blank');
      };
      frag.appendChild(div);
    });
    searchResults.appendChild(frag);
  }

  // fetch & normalize
  async function fetchAndNormalize(label){
    if(bibleNormCache[label]) return bibleNormCache[label];
    const url = BASE + versionMap[label];
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed ' + res.status);
    const j = await res.json();
    bibleRawCache[label] = j;
    const norm = normalize(j);
    bibleNormCache[label] = norm;
    buildSearchIndex(label, norm);
    return norm;
  }

  // events
  jumpToggle.onclick = ()=> {
    const show = jumpBody.style.display === 'block';
    jumpBody.style.display = show ? 'none' : 'block';
    jumpBody.setAttribute('aria-hidden', show ? 'true' : 'false');
  };

  primarySelect.onchange = async function(){
    const label = this.value;
    if(!label) return;
    current.version = label;
    current.book = 0; current.chapter = 0; current.singleVerseMode = false; current.singleVerseIndex = null; verseRange.value = '';
    try{ await fetchAndNormalize(label); showNotice(label + ' loaded',900); }catch(e){ showNotice('Load failed'); return; }
    bookSelect.innerHTML = "<option value=''>Book</option>";
    bibleNormCache[label].books.forEach((b,i)=> bookSelect.appendChild(new Option(b.name,i)));
    chapterSelect.innerHTML = "<option value=''>Chapter</option>";
    verseSelect.innerHTML = "<option value=''>Verse</option>";
    versesContainer.innerHTML = "<div style='padding:12px'>Click Go to open read.html for a book/chapter.</div>";
  };

  parallelSelect.onchange = async function(){ current.parallel = this.value || null; if(current.parallel) try{ await fetchAndNormalize(current.parallel); showNotice('Parallel loaded',700);}catch(e){} };

  openBtn.onclick = function(){
    if(!current.version) { showNotice('Select primary version'); return; }
    // open book 0, chapter 1 (in new tab)
    const params = new URLSearchParams();
    params.set('version', current.version);
    params.set('bookIndex', 0);
    params.set('chapter', 1);
    window.open('read.html?' + params.toString(), '_blank');
  };

  jumpGo.onclick = function(){
    if(!current.version){ showNotice('Select primary version'); return; }
    if(bookSelect.value !== "") current.book = Number(bookSelect.value);
    if(chapterSelect.value !== "") current.chapter = Number(chapterSelect.value);
    const rangeInput = (verseRange.value || '').trim();
    const viDropdown = verseSelect.value !== '' ? Number(verseSelect.value) : null;

    const params = new URLSearchParams();
    params.set('version', current.version);
    params.set('bookIndex', current.book);
    params.set('chapter', current.chapter + 1);

    if(rangeInput) params.set('verse', rangeInput);
    else if(viDropdown !== null) params.set('verse', viDropdown + 1);

    window.open('read.html?' + params.toString(), '_blank');
  };

  bookSelect.onchange = function(){
    current.book = Number(this.value || 0);
    current.chapter = 0;
    current.singleVerseMode = false; current.singleVerseIndex = null; verseRange.value = '';
    if(!current.version) return;
    const chapters = bibleNormCache[current.version].books[current.book].chapters.length;
    chapterSelect.innerHTML = "<option value=''>Chapter</option>";
    for(let c=1;c<=chapters;c++) chapterSelect.appendChild(new Option(c,c-1));
    verseSelect.innerHTML = "<option value=''>Verse</option>";
  };

  chapterSelect.onchange = function(){
    current.chapter = Number(this.value || 0);
    current.singleVerseMode = false; current.singleVerseIndex = null; verseRange.value = '';
    if(!current.version) return;
    const verses = bibleNormCache[current.version].books[current.book].chapters[current.chapter].length;
    verseSelect.innerHTML = "<option value=''>Verse</option>";
    for(let v=1; v<=verses; v++) verseSelect.appendChild(new Option(v, v-1));
  };

  // Search
  searchBtn.onclick = runSearch;
  searchBox.onkeydown = e => { if(e.key === 'Enter') runSearch(); };

  // initial
  versesContainer.innerHTML = "<div style='padding:12px'>Choose PRIMARY version → Load books, then use Go to open read.html.</div>";
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader</title>

<link rel="preload" as="image" href="icons/bible.jpg">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ============================
   THEME VARIABLES
   ============================ */
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --muted:#2b3440;
  --accent:#0b66c2;
  --border:#e6edf6;
  --soft:#f1f6fb;
  --glass-alpha:0.78;
}
:root.dark{
  --bg:#0b1117;
  --card:#131b23;
  --muted:#dce7f5;
  --accent:#8dbdff;
  --border:#1f2a36;
  --soft:#1a232d;
  --glass-alpha:0.65;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:var(--bg);
  color:var(--muted);
  -webkit-font-smoothing:antialiased;
}

/* ============================
   TOPBAR
   ============================ */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:var(--card);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:220;
}
.left,.right{display:flex;align-items:center;gap:12px}
.brand{font-weight:700;color:var(--accent);font-size:18px;display:flex;gap:8px;align-items:center}
.bible-icon{width:40px;height:40px;object-fit:contain}
.icon-btn{border:0;background:transparent;color:var(--muted);font-size:18px;padding:6px;cursor:pointer}

/* ============================
   TABS
   ============================ */
.tabs{display:flex;justify-content:center;background:var(--card);border-bottom:1px solid var(--border)}
.tab-btn{
  padding:12px 18px;cursor:pointer;border:0;background:transparent;font-size:16px;color:var(--muted)
}
.tab-btn.active{font-weight:700;color:var(--accent);border-bottom:3px solid var(--accent)}

/* ============================
   TOOLBAR - Compact Auto-fit Grid
   ============================ */
.toolbar{
  padding:10px 12px;background:var(--bg);border-bottom:1px solid var(--border);
}
.toolbar-inner{
  max-width:1120px;margin:0 auto;display:grid;gap:10px;
  /* compact auto-fit layout: each cell min 120px, grow as needed */
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  align-items:center;
}

/* ensure the last column (controls) doesn't expand too wide */
.toolbar-inner > .controls { justify-self:end; display:flex; gap:10px; align-items:center; }

/* selects & button */
.compact-select{
  width:100%;padding:9px 12px;border-radius:12px;border:1px solid var(--border);
  background:var(--card);color:var(--muted);font-size:14px;
}
:root.dark .compact-select{ background:var(--soft); border-color:var(--border) }

.open-picker{
  padding:9px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);cursor:pointer;
}
:root.dark .open-picker{ background:var(--soft) }

/* ============================
   TTS small round buttons (compact)
   ============================ */
.tts-row{ display:flex; gap:8px; align-items:center; white-space:nowrap; }
.tts-btn{
  width:34px;height:34px;border-radius:50%;border:0;background:var(--accent);color:#fff;
  display:inline-flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;
}
.tts-btn.stop{ background:#ff5f5f }

/* small control for icon-only Book button (keeps layout stable) */
.icon-book{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--card);cursor:pointer;
}

/* ============================
   READER
   ============================ */
.reader-container{max-width:980px;margin:16px auto;padding:0 14px}
.reader-card{background:var(--card);border-radius:14px;padding:16px;border:1px solid var(--border)}
.chapter-ref{text-align:center;color:var(--accent);font-size:20px;font-weight:700;margin-bottom:10px}

.parallel-labels{display:none;margin-bottom:8px;justify-content:space-between}
.parallel-label{font-size:13px;color:var(--accent);font-weight:700}

.verses{max-height:70vh;overflow:auto;padding-bottom:40px}
.verse-block{background:var(--soft);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)}
.verse-number{font-size:13px;font-weight:700;margin-bottom:8px;color:#6a7a8e}
.verse-primary{font-size:18px;line-height:1.75;font-family:"Noto Serif",serif}
.verse-parallel{margin-top:10px;padding-left:12px;border-left:3px solid var(--accent);font-size:16px;color:#2b435b}

/* ============================
   BOOK PICKER (centered bottom sliding panel)
   ============================ */
.picker-panel{
  position:fixed;left:50%;transform:translateX(-50%) translateY(110%);
  bottom:0;z-index:320;
  width:min(880px, calc(100% - 40px));
  height:340px;background:var(--card);border-radius:16px 16px 0 0;
  border:1px solid var(--border);box-shadow:0 -8px 30px rgba(0,0,0,0.08);
  transition:transform .28s ease;
}
.picker-panel.show{ transform:translateX(-50%) translateY(0) }

.picker-top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);font-weight:700}
.handle{width:44px;height:6px;border-radius:6px;background:var(--soft);margin-right:12px}
.picker-body{padding:16px;display:flex;flex-direction:column;gap:12px}
.large-select{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card)}

/* small screens */
@media(max-width:640px){
  .toolbar-inner{ grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); }
  .tts-btn{ width:32px;height:32px;font-size:13px }
}

/* ============================
   NOTICE
   ============================ */
.notice{position:fixed;left:16px;right:16px;top:80px;padding:10px;border-radius:8px;text-align:center;z-index:400}
.hidden{display:none}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="left">
    <img src="icons/bible.jpg" class="bible-icon" alt="Bible icon">
    <div class="brand">Bible Reader</div>
  </div>
  <div class="right">
    <button id="themeToggle" class="icon-btn" title="Toggle theme">üåô</button>
  </div>
</header>

<!-- TABS -->
<div class="tabs" role="tablist" aria-label="Main tabs">
  <button id="tabRead" class="tab-btn active" role="tab">Read</button>
  <button id="tabSearch" class="tab-btn" role="tab">Search</button>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-inner" role="toolbar" aria-label="Version controls">
    <select id="versionCompact" class="compact-select" aria-label="Primary version">
      <option value="">Version</option>
    </select>

    <select id="parallelVersion" class="compact-select" aria-label="Parallel version">
      <option value="">Parallel</option>
    </select>

    <button id="openPicker" class="open-picker" title="Select book & chapter">üìö Book</button>

    <!-- controls area aligned to right -->
    <div class="controls" style="grid-column:span 1; justify-self:end;">
      <div class="tts-row" role="group" aria-label="Text-to-speech controls">
        <button id="ttsPlay" class="tts-btn" title="Play">‚ñ∂</button>
        <button id="ttsPause" class="tts-btn" title="Pause">‚è∏</button>
        <button id="ttsResume" class="tts-btn" title="Resume">‚èµ</button>
        <button id="ttsStop" class="tts-btn stop" title="Stop">‚èπ</button>
      </div>
    </div>
  </div>
</div>

<!-- READ SECTION -->
<section id="readSection">
  <main class="reader-container">
    <article class="reader-card">
      <h2 id="currentRef" class="chapter-ref">‚Äî</h2>

      <div id="parallelLabels" class="parallel-labels">
        <div id="labelPrimary" class="parallel-label"></div>
        <div id="labelParallel" class="parallel-label"></div>
      </div>

      <div id="verses" class="verses" tabindex="0" aria-live="polite"></div>
    </article>
  </main>
</section>

<!-- SEARCH SECTION (hidden by default) -->
<section id="searchSection" style="display:none;max-width:980px;margin:16px auto;padding:0 14px;">
  <input id="searchInput" class="compact-select" style="width:100%;margin-bottom:12px" placeholder="Search text (select a version first)">
  <div id="searchResults"></div>
</section>

<!-- BOOK PICKER -->
<div id="pickerPanel" class="picker-panel" aria-hidden="true">
  <div class="picker-top">
    <div style="display:flex;align-items:center;">
      <div class="handle" aria-hidden="true"></div>
      <div>Select Book & Chapter</div>
    </div>
    <button id="closePicker" class="icon-btn" aria-label="Close picker">‚úñ</button>
  </div>

  <div class="picker-body">
    <select id="bookSelect" class="large-select" aria-label="Book"><option>Loading...</option></select>
    <select id="chapterSelect" class="large-select" aria-label="Chapter"></select>
    <div style="display:flex;justify-content:flex-end">
      <button id="gotoBtn" class="open-picker">Go</button>
    </div>
  </div>
</div>

<div id="notice" class="notice hidden" role="status" aria-live="polite"></div>

<script>
(function(){

// Candidate files - adjust to match files in /versions/
const FILES=[
  "KJV_bible.json","NIV_bible.json","NLT_bible.json","NKJV_bible.json","ESV_bible.json",
  "tamil_bible.json","telugu_bible.json","hindi_bible.json","malayalam_bible.json",
  "kannada_bible.json","marathi_bible.json","gujarati_bible.json","bengali_bible.json",
  "punjabi_bible.json","odia_bible.json","nepali_bible.json","afrikaans_bible.json"
];

let versionsList=[];
const bibleCache={};
let current={version:null, bookIndex:0, chapterIndex:0};
let parallel={version:null};

// DOM
const versionCompact=document.getElementById('versionCompact');
const parallelVersion=document.getElementById('parallelVersion');
const openPicker=document.getElementById('openPicker');
const pickerPanel=document.getElementById('pickerPanel');
const closePicker=document.getElementById('closePicker');
const bookSelect=document.getElementById('bookSelect');
const chapterSelect=document.getElementById('chapterSelect');
const gotoBtn=document.getElementById('gotoBtn');

const versesEl=document.getElementById('verses');
const currentRef=document.getElementById('currentRef');
const labelPrimary=document.getElementById('labelPrimary');
const labelParallel=document.getElementById('labelParallel');
const parallelLabels=document.getElementById('parallelLabels');

const ttsPlay=document.getElementById('ttsPlay');
const ttsPause=document.getElementById('ttsPause');
const ttsResume=document.getElementById('ttsResume');
const ttsStop=document.getElementById('ttsStop');

const tabRead=document.getElementById('tabRead');
const tabSearch=document.getElementById('tabSearch');
const readSection=document.getElementById('readSection');
const searchSection=document.getElementById('searchSection');
const searchInput=document.getElementById('searchInput');
const searchResults=document.getElementById('searchResults');

const themeToggle=document.getElementById('themeToggle');

document.addEventListener('DOMContentLoaded', init);

async function init(){
  await discoverVersions();
  populateSelectors();
  attachUI();
  restoreTheme();
}

// Try to detect which JSON files exist
async function discoverVersions(){
  versionsList=[];
  for(const f of FILES){
    try{
      const url='versions/'+f;
      // HEAD preferred (fast & small), try it and fallback to GET
      let ok=false;
      try{
        const r=await fetch(url,{method:'HEAD'});
        ok=r.ok;
      }catch(e){
        const r2=await fetch(url);
        ok=r2.ok;
      }
      if(ok){
        const label = f.replace(/_bible|\.json/gi,'').replace(/[-_]/g,' ').toUpperCase();
        versionsList.push({label,path:url});
      }
    }catch(e){}
  }
}

function populateSelectors(){
  versionCompact.innerHTML='<option value="">Version</option>';
  parallelVersion.innerHTML='<option value="">Parallel</option>';
  versionsList.forEach(v=>{
    versionCompact.appendChild(new Option(v.label, v.label));
    parallelVersion.appendChild(new Option(v.label, v.label));
  });
}

function attachUI(){
  versionCompact.onchange = async () => {
    const label = versionCompact.value;
    if(!label) return;
    current.version = label;
    labelPrimary.textContent = label;
    await loadVersion(label);
    populateBooks();
    // open book picker for quick selection
    pickerPanel.classList.add('show');
    pickerPanel.setAttribute('aria-hidden','false');
  };

  parallelVersion.onchange = async () => {
    parallel.version = parallelVersion.value || null;
    if(parallel.version){
      labelParallel.textContent = parallel.version;
      parallelLabels.style.display = 'flex';
      await loadVersion(parallel.version);
    } else {
      parallelLabels.style.display = 'none';
    }
    renderChapter();
  };

  openPicker.onclick = ()=> {
    pickerPanel.classList.add('show');
    pickerPanel.setAttribute('aria-hidden','false');
  };
  closePicker.onclick = ()=> {
    pickerPanel.classList.remove('show');
    pickerPanel.setAttribute('aria-hidden','true');
  };

  bookSelect.onchange = ()=> populateChaptersForBook(Number(bookSelect.value));
  gotoBtn.onclick = ()=> {
    current.bookIndex = Number(bookSelect.value);
    current.chapterIndex = Number(chapterSelect.value);
    pickerPanel.classList.remove('show');
    renderChapter();
  };

  // Tabs
  tabRead.onclick = ()=> switchTab('read');
  tabSearch.onclick = ()=> switchTab('search');

  // Search
  searchInput.oninput = debounce(runSearch, 220);

  // TTS
  ttsPlay.onclick = startTTS;
  ttsPause.onclick = ()=> speechSynthesis.pause();
  ttsResume.onclick = ()=> speechSynthesis.resume();
  ttsStop.onclick = ()=> stopTTS();

  // Theme
  themeToggle.onclick = ()=> {
    const on = document.documentElement.classList.toggle('dark');
    if(on) localStorage.setItem('darkMode','1'); else localStorage.removeItem('darkMode');
  };
}

// Load & cache JSON
async function loadVersion(label){
  if(bibleCache[label]) return;
  const entry = versionsList.find(v=>v.label===label);
  if(!entry) return;
  try{
    const r = await fetch(entry.path);
    const j = await r.json();
    bibleCache[label] = normalizeBible(j);
  }catch(e){
    showNotice('Failed to load ' + label, 2200);
  }
}

function normalizeBible(data){
  const out={books:[]};
  if(data && Array.isArray(data.books)){
    out.books = data.books.map(b=>({
      name: b.name || b.book || 'Unknown',
      chapters: (b.chapters||[]).map(c => Array.isArray(c) ? c : Object.values(c||{}))
    }));
    return out;
  }
  for(const bk of Object.keys(data||{})){
    const bookObj = data[bk];
    const chapters=[];
    if(bookObj && Array.isArray(bookObj.chapters)){
      for(const c of bookObj.chapters) chapters.push(Array.isArray(c) ? c : Object.values(c||{}));
    } else {
      const keys = Object.keys(bookObj||{}).sort((a,b)=>Number(a)-Number(b));
      for(const k of keys){
        const ch = bookObj[k];
        if(Array.isArray(ch)) chapters.push(ch);
        else if(typeof ch === 'object') chapters.push(Object.keys(ch).sort((a,b)=>Number(a)-Number(b)).map(vk=>ch[vk]));
        else chapters.push([String(ch)]);
      }
    }
    out.books.push({name:bk, chapters});
  }
  return out;
}

function populateBooks(){
  const data = bibleCache[current.version];
  if(!data) return;
  bookSelect.innerHTML = '';
  data.books.forEach((b,i)=> bookSelect.appendChild(new Option(b.name, i)));
  populateChaptersForBook(0);
}

function populateChaptersForBook(bookIndex){
  const chs = bibleCache[current.version].books[bookIndex].chapters;
  chapterSelect.innerHTML = '';
  for(let i=0;i<chs.length;i++) chapterSelect.appendChild(new Option(String(i+1), i));
  chapterSelect.value = 0;
  current.bookIndex = bookIndex;
  current.chapterIndex = 0;
}

function renderChapter(){
  if(!current.version){ versesEl.innerHTML = '<div style="padding:12px">Select a version</div>'; return; }
  const book = bibleCache[current.version].books[current.bookIndex];
  const chArr = book?.chapters?.[current.chapterIndex] || [];
  currentRef.textContent = `${book?.name || ''} ${current.chapterIndex + 1}`;

  let pArr = null;
  if(parallel.version && bibleCache[parallel.version]){
    const pb = bibleCache[parallel.version].books[current.bookIndex];
    pArr = pb?.chapters?.[current.chapterIndex] || [];
  }

  const max = Math.max(chArr.length, pArr ? pArr.length : 0);
  let html = '';
  for(let i=0;i<max;i++){
    const a = chArr[i] || '';
    const b = pArr ? (pArr[i] || '') : '';
    html += `
      <div class="verse-block">
        <div class="verse-number">Verse ${i+1}</div>
        <div class="verse-primary">${escapeHtml(a)}</div>
        ${parallel.version ? `<div class="verse-parallel">${escapeHtml(b)}</div>` : ''}
      </div>
    `;
  }
  versesEl.innerHTML = html;
  versesEl.scrollTop = 0;
}

function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function showNotice(msg, ms=2000){
  const n = document.getElementById('notice');
  n.textContent = msg; n.classList.remove('hidden');
  setTimeout(()=> n.classList.add('hidden'), ms);
}

/* ============================
   SEARCH
   ============================ */
function runSearch(){
  const q = (searchInput.value || '').trim().toLowerCase();
  if(!q){ searchResults.innerHTML=''; return; }
  if(!current.version){ searchResults.innerHTML='<div>Please select a version first</div>'; return; }

  const data = bibleCache[current.version];
  if(!data){ searchResults.innerHTML='<div>Version not loaded</div>'; return; }

  let out = '';
  data.books.forEach((bk,bi)=>{
    bk.chapters.forEach((ch,ci)=>{
      ch.forEach((v,vi)=>{
        if(String(v).toLowerCase().includes(q)){
          out += `<div class="search-result" style="padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;"
                    onclick="openSearchResult(${bi},${ci})">
                    <strong>${bk.name} ${ci+1}:${vi+1}</strong><div>${escapeHtml(v)}</div></div>`;
        }
      });
    });
  });
  searchResults.innerHTML = out || '<div>No results</div>';
}
window.openSearchResult = function(book,chapter){
  current.bookIndex = book; current.chapterIndex = chapter;
  switchTab('read');
  renderChapter();
}

/* ============================
   TTS (Primary only)
   ============================ */
let queue = [];
function startTTS(){
  stopTTS();
  const nodes = Array.from(document.querySelectorAll('.verse-primary'));
  queue = nodes.map(n => n.textContent.trim()).filter(Boolean);
  speakNext();
}
function speakNext(){
  if(!queue.length) return;
  if(!('speechSynthesis' in window)){ showNotice('TTS not supported'); return; }
  const t = queue.shift();
  const utt = new SpeechSynthesisUtterance(t);
  utt.rate = 1.0;
  utt.onend = ()=> setTimeout(speakNext, 100);
  utt.onerror = ()=> setTimeout(speakNext, 120);
  speechSynthesis.speak(utt);
}
function stopTTS(){ if('speechSynthesis' in window) speechSynthesis.cancel(); queue = []; }

/* ============================
   Tabs
   ============================ */
function switchTab(t){
  if(t==='read'){
    tabRead.classList.add('active');
    tabSearch.classList.remove('active');
    readSection.style.display = '';
    searchSection.style.display = 'none';
  } else {
    tabSearch.classList.add('active');
    tabRead.classList.remove('active');
    readSection.style.display = 'none';
    searchSection.style.display = '';
  }
}

/* ============================
   Theme
   ============================ */
function restoreTheme(){ if(localStorage.getItem('darkMode')) document.documentElement.classList.add('dark'); }

/* ============================
   Small helpers
   ============================ */
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

// allow small keyboard play/pause
document.addEventListener('keydown', e=>{
  if(e.code === 'Space' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){
    e.preventDefault();
    if(speechSynthesis.paused) speechSynthesis.resume();
    else if(speechSynthesis.speaking) speechSynthesis.pause();
    else startTTS();
  }
});

})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — SPA (Read / Search / Parallel)</title>

<!-- Font Awesome (free) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Serif font for verses -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f7f9fc; --card:#fff; --accent:#0b66c2; --muted:#6f7f8b;
  --border:#e6eef6; --soft:#f4f8ff; --highlight:#fff8d1;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#152a33;-webkit-font-smoothing:antialiased}

/* header */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:120;
}
.brand{font-weight:800;color:var(--accent);font-size:20px}
.tabbar{display:flex;gap:6px;align-items:center}
.tab{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;font-weight:700}
.tab.active{background:#eaf6ff;color:var(--accent);box-shadow:0 1px 4px rgba(11,102,194,0.10)}

/* layout */
.app{max-width:1100px;margin:18px auto;padding:0 18px}
.controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:16px 0}
select,input,button{font-size:14px}
select,input{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card)}
button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}

/* jump */
.jump-container{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0;margin-bottom:16px}
.jump-header{padding:12px 14px;background:var(--soft);font-weight:700;color:var(--accent);cursor:pointer;border-radius:10px 10px 0 0}
.jump-body{padding:12px 14px;display:none}

/* panes (tab content) */
.pane{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;min-height:120px;display:none;opacity:0;transform:translateY(6px);transition:all .25s ease}
.pane.show{display:block;opacity:1;transform:translateY(0)}

/* reader */
.reader-top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
.select{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card)}
.ref{font-size:22px;font-weight:700;color:var(--accent);margin-bottom:12px}
.verse-block{background:#fff;padding:14px;border-radius:10px;border:1px solid var(--border);margin-bottom:12px}
.verse-num{font-weight:700;color:#345;margin-bottom:6px;font-size:13px}
.verse-primary{font-family:"Noto Serif",serif;font-size:18px;line-height:1.7;color:#111}
.verse-parallel{margin-top:10px;padding-left:14px;border-left:3px solid var(--accent);font-family:"Noto Serif",serif;font-size:17px;color:#2a3c55}
.active-verse{background:var(--highlight);border-color:#dccb6e}

/* search */
.search-item{padding:12px;border-radius:10px;border:1px solid var(--border);background:#fff;margin-bottom:10px;cursor:pointer}
.highlight{background:#fff3c4;padding:2px;border-radius:4px}

/* small nav */
.nav-row{display:flex;gap:10px;align-items:center;margin:10px 0}
.small{padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}

/* books preview */
.book-item{padding:10px;border-bottom:1px dashed #f0f4f8}

/* notice */
.notice{position:fixed;left:20px;right:20px;top:80px;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;text-align:center;display:none;z-index:400;color:#222}

/* responsive */
@media(max-width:720px){
  .controls select,input{width:100%}
  .header{padding:12px}
  .tab{padding:8px 10px}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">Bible Reader</div>
  <nav class="tabbar" role="navigation" aria-label="Top tabs">
    <div class="tab" data-tab="read" id="tab-read"><i class="fa-solid fa-book"></i><span>READ</span></div>
    <div class="tab" data-tab="search" id="tab-search"><i class="fa-solid fa-magnifying-glass"></i><span>SEARCH</span></div>
    <div class="tab" data-tab="parallel" id="tab-parallel"><i class="fa-solid fa-columns"></i><span>PARALLEL</span></div>
  </nav>
</header>

<main class="app" id="app">
  <!-- Top controls (shared) -->
  <div class="controls" id="topControls">
    <select id="primarySelect" aria-label="Primary version"><option value="">PRIMARY VERSION</option></select>
    <select id="parallelSelect" aria-label="Parallel version"><option value="">PARALLEL VERSION</option></select>
    <button id="openBtn">Open (first book)</button>

    <input id="searchBox" placeholder="Search Text…" style="min-width:220px" />
    <button id="searchBtn">Search</button>
  </div>

  <!-- Jump -->
  <div class="jump-container" id="jumpBox">
    <div class="jump-header" id="jumpToggle">▼ Jump to Book / Chapter / Verse</div>
    <div class="jump-body" id="jumpBody">
      <select id="bookSelect"><option>Book</option></select>
      <select id="chapterSelect"><option>Chapter</option></select>
      <select id="verseSelect"><option>Verse</option></select>
      <input id="verseRange" placeholder="Verse or range (e.g. 7 or 7-8)" />
      <button id="jumpGo">Go</button>
    </div>
  </div>

  <!-- READ pane -->
  <section id="pane-read" class="pane" role="region" aria-label="Read">
    <div class="reader-top">
      <select id="primarySelReader" class="select" aria-label="Primary in reader"></select>
      <select id="parallelSelReader" class="select" aria-label="Parallel in reader"></select>

      <button id="ttsPlay" class="small">▶ Play</button>
      <button id="ttsPause" class="small">⏸ Pause</button>
      <button id="ttsResume" class="small">⏯ Resume</button>
      <button id="ttsStop" class="small">⏹ Stop</button>

      <div style="flex:1"></div>
      <div style="color:#666;font-size:13px">Swipe / Drag / Arrow keys</div>
    </div>

    <div class="nav-row" id="readerNav" style="display:none">
      <button id="prevVerse" class="small">◀ Prev Verse</button>
      <button id="nextVerse" class="small">Next Verse ▶</button>
      <button id="prevChapter" class="small">◀ Prev Chapter</button>
      <button id="nextChapter" class="small">Next Chapter ▶</button>
    </div>

    <div id="currentRef" class="ref" style="margin-bottom:12px"></div>
    <div id="versesContainer" tabindex="0"></div>
  </section>

  <!-- SEARCH pane -->
  <section id="pane-search" class="pane" role="region" aria-label="Search">
    <div id="searchInfo" style="margin-bottom:8px;color:#666"></div>
    <div id="searchResults"></div>
  </section>

  <!-- PARALLEL pane -->
  <section id="pane-parallel" class="pane" role="region" aria-label="Parallel">
    <div style="margin-bottom:10px;font-weight:700">Parallel: choose two versions and press Open</div>
    <div id="parallelView"></div>
  </section>

</main>

<div id="notice" class="notice" role="status" aria-live="polite"></div>

<script>
/* SPA main JS
   - top tabs (read/search/parallel)
   - version lists (uppercase labels)
   - normalization of different json shapes
   - reader: chapter/full, verse, range, tts, swipe/drag/keys
   - search: highlight, deep-links into read pane
   - parallel pane: side-by-side (or stacked)
*/

(async function(){
  const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";
  const FILES = [
"AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json",
"NIV_bible.json","NKJV_bible.json","NLT_bible.json","afrikaans_bible.json",
"bengali_bible.json","gujarati_bible.json","hindi_bible.json",
"hungarian_bible.json","indonesian_bible.json","kannada_bible.json",
"malayalam_bible.json","marathi_bible.json","nepali_bible.json",
"odia_bible.json","punjabi_bible.json","sepedi_bible.json",
"tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
  ];

  // DOM
  const tabs = document.querySelectorAll('.tab');
  const paneRead = document.getElementById('pane-read');
  const paneSearch = document.getElementById('pane-search');
  const paneParallel = document.getElementById('pane-parallel');
  const tabRead = document.getElementById('tab-read');
  const tabSearch = document.getElementById('tab-search');
  const tabParallel = document.getElementById('tab-parallel');

  const primarySelect = document.getElementById('primarySelect');
  const parallelSelect = document.getElementById('parallelSelect');
  const openBtn = document.getElementById('openBtn');
  const searchBox = document.getElementById('searchBox');
  const searchBtn = document.getElementById('searchBtn');

  const jumpToggle = document.getElementById('jumpToggle');
  const jumpBody = document.getElementById('jumpBody');
  const bookSelect = document.getElementById('bookSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const verseSelect = document.getElementById('verseSelect');
  const verseRange = document.getElementById('verseRange');
  const jumpGo = document.getElementById('jumpGo');

  const primarySelReader = document.getElementById('primarySelReader');
  const parallelSelReader = document.getElementById('parallelSelReader');
  const ttsPlay = document.getElementById('ttsPlay');
  const ttsPause = document.getElementById('ttsPause');
  const ttsResume = document.getElementById('ttsResume');
  const ttsStop = document.getElementById('ttsStop');
  const currentRef = document.getElementById('currentRef');
  const versesContainer = document.getElementById('versesContainer');
  const readerNav = document.getElementById('readerNav');
  const prevVerseBtn = document.getElementById('prevVerse');
  const nextVerseBtn = document.getElementById('nextVerse');
  const prevChapBtn = document.getElementById('prevChapter');
  const nextChapBtn = document.getElementById('nextChapter');

  const searchInfo = document.getElementById('searchInfo');
  const searchResults = document.getElementById('searchResults');
  const parallelView = document.getElementById('parallelView');

  const notice = document.getElementById('notice');

  // helper UI funcs
  function showNotice(msg, ms=1400){ notice.textContent = msg; notice.style.display='block'; setTimeout(()=> notice.style.display='none', ms); }
  function esc(s){ return (s===undefined||s===null) ? '' : String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function sortKeys(keys){ return keys.sort((a,b)=> (parseInt(String(a).split('-')[0])||0) - (parseInt(String(b).split('-')[0])||0)); }

  // normalize JSON shapes
  function normalize(json){
    if(!json) return {books:[]};
    if(json.books && Array.isArray(json.books)){
      return { books: json.books.map(b=>({
        name: b.name || b.book || "Unknown",
        chapters: (b.chapters || []).map(ch=>{
          if(Array.isArray(ch)) return ch.map((t,i)=>({key:String(i+1), text:t}));
          if(typeof ch === 'object'){ const vk = sortKeys(Object.keys(ch||{})); return vk.map(k=>({key:k, text: ch[k]})); }
          return [];
        })
      }))};
    }
    // object keyed by book name
    const books=[];
    for(const bk of Object.keys(json||{})){
      const bookObj = json[bk];
      if(!bookObj || typeof bookObj !== 'object') continue;
      const chKeys = Object.keys(bookObj).sort((a,b)=>Number(a)-Number(b));
      const chapters = [];
      for(const ck of chKeys){
        const ch = bookObj[ck];
        if(!ch || typeof ch !== 'object'){ chapters.push([]); continue; }
        const vkeys = sortKeys(Object.keys(ch||{}));
        chapters.push(vkeys.map(k=>({key:k, text: ch[k]})));
      }
      books.push({ name: bk, chapters });
    }
    return { books };
  }

  // caches and state
  const rawCache = {};    // raw json
  const normCache = {};   // normalized
  const searchCache = {}; // flattened index
  const state = { view: 'read', version: null, parallel: null, bookIndex:0, chapter:0, verse: null };

  // fill selects (display uppercase)
  FILES.forEach(f=>{
    const label = f.replace("_bible.json","").replace(".json","").toUpperCase();
    primarySelect.appendChild(new Option(label, f));
    parallelSelect.appendChild(new Option(label, f));
    primarySelReader.appendChild(new Option(label, f));
    parallelSelReader.appendChild(new Option(label, f));
  });

  // utility fetch + normalize
  async function fetchNorm(file){
    if(!file) throw new Error("No file");
    if(normCache[file]) return normCache[file];
    const res = await fetch(BASE + file);
    if(!res.ok) throw new Error("Fetch failed "+res.status+" for "+file);
    const j = await res.json();
    rawCache[file] = j;
    const n = normalize(j);
    normCache[file] = n;
    buildSearchIndex(file, n);
    return n;
  }

  // search index builder
  function buildSearchIndex(file, norm){
    if(searchCache[file]) return searchCache[file];
    const arr=[];
    norm.books.forEach((b,bi)=>{
      b.chapters.forEach((ch,ci)=>{
        ch.forEach((v,vi)=>{
          const t = (v && v.text) ? v.text : "";
          arr.push({bookIndex:bi, chapterIndex:ci, verseIndex:vi, book:b.name, chapter:ci+1, verseKey:v.key, text:t, low:t.toLowerCase()});
        });
      });
    });
    searchCache[file] = arr;
    return arr;
  }

  // parse initial URL -> state
  function readUrlToState(){
    const p = new URLSearchParams(location.search);
    const ver = p.get('version') || FILES.find(f=>f.includes('telugu')) || FILES[0];
    state.version = ver.endsWith('.json') ? ver : ver + '.json';
    const par = p.get('parallel');
    state.parallel = par ? (par.endsWith('.json') ? par : par + '.json') : null;
    state.bookIndex = Number(p.get('bookIndex') || 0);
    state.chapter = Number(p.get('chapter') ? Number(p.get('chapter')) - 1 : 0);
    state.verse = p.get('verse') || null;
    state.view = p.get('view') || (p.get('chapter') ? 'read' : 'read');
  }
  readUrlToState();

  // tabs switching
  function activateTab(name, push=true){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    paneRead.classList.toggle('show', name === 'read');
    paneSearch.classList.toggle('show', name === 'search');
    paneParallel.classList.toggle('show', name === 'parallel');
    state.view = name;
    // update history
    const p = new URLSearchParams();
    p.set('view', state.view);
    if(state.version) p.set('version', state.version);
    if(state.parallel) p.set('parallel', state.parallel);
    p.set('bookIndex', String(state.bookIndex));
    p.set('chapter', String(state.chapter + 1));
    if(state.verse) p.set('verse', state.verse);
    const url = '?' + p.toString();
    if(push) history.pushState({...state}, '', url); else history.replaceState({...state}, '', url);
  }
  tabs.forEach(tab => tab.addEventListener('click', ()=> activateTab(tab.dataset.tab)));

  // show page-level UI
  function showListMode(){
    activateTab('read', false);
  }

  // render books preview (light)
  async function renderBooksPreview(){
    // optional - not heavy; used when primary selected
    try{
      if(!state.version) return;
      const n = await fetchNorm(state.version);
      // populate book select
      bookSelect.innerHTML = "<option value=''>Book</option>";
      n.books.forEach((b,i)=> bookSelect.appendChild(new Option(b.name, i)));
    }catch(e){}
  }

  // READ rendering (chapter, verse, range)
  function renderChapter(){
    const vfile = state.version;
    if(!vfile || !normCache[vfile]){ versesContainer.innerHTML = '<div style="padding:12px">Select a primary version</div>'; currentRef.textContent = ''; return; }
    const book = normCache[vfile].books[state.bookIndex];
    if(!book){ versesContainer.innerHTML = '<div style="padding:12px">Book not found</div>'; currentRef.textContent=''; return; }
    if(state.chapter < 0) state.chapter = 0;
    if(state.chapter >= book.chapters.length) state.chapter = 0;
    const chapterArr = book.chapters[state.chapter] || [];
    currentRef.textContent = `${book.name} ${state.chapter + 1} ${state.parallel ? '— ' + (state.parallel.replace('_bible.json','').replace('.json','').toUpperCase()) : ''}`;
    versesContainer.innerHTML = '';

    // parallel chapter array if available
    const parArr = (state.parallel && normCache[state.parallel] && normCache[state.parallel].books[state.bookIndex]) ? (normCache[state.parallel].books[state.bookIndex].chapters[state.chapter] || []) : [];

    // If verse param exists -> handle exact key, range, or numeric
    if(state.verse){
      // exact key match
      const exact = chapterArr.findIndex(v => v.key === state.verse);
      if(exact !== -1){ renderVerseBlock(exact, chapterArr, parArr); showReaderNav(true, exact); return; }
      // range like 7-8
      const m = state.verse.match(/^(\d+)\s*-\s*(\d+)$/);
      if(m){
        const s = Math.max(1, Number(m[1])) - 1;
        const e = Math.max(1, Number(m[2])) - 1;
        const start = Math.max(0, Math.min(s, chapterArr.length - 1));
        const end = Math.max(start, Math.min(e, chapterArr.length - 1));
        renderCombinedRange(start, end, chapterArr, parArr); showReaderNav(true, start); return;
      }
      // numeric single
      if(/^\d+$/.test(state.verse)){
        const idx = Math.max(0, Math.min(Number(state.verse) - 1, chapterArr.length - 1));
        renderVerseBlock(idx, chapterArr, parArr); showReaderNav(true, idx); return;
      }
      versesContainer.innerHTML = '<div style="padding:12px;color:#666">Verse not found</div>'; showReaderNav(false); return;
    }

    // else full chapter
    for(let i=0;i<chapterArr.length;i++){
      const v = chapterArr[i];
      const block = document.createElement('div');
      block.className = 'verse-block';
      const parText = (parArr[i] && parArr[i].text) ? parArr[i].text : '';
      block.innerHTML = `<div class="verse-num">Verse ${v.key}</div>
        <div class="verse-primary">${esc(v.text)}</div>
        ${ parText ? `<div class="verse-parallel">${esc(parText)}</div>` : '' }`;
      versesContainer.appendChild(block);
    }
    showReaderNav(false);
  }

  function renderVerseBlock(index, chapterArr, parArr){
    versesContainer.innerHTML = '';
    const v = chapterArr[index];
    const parText = (parArr[index] && parArr[index].text) ? parArr[index].text : '';
    const block = document.createElement('div');
    block.className = 'verse-block active-verse';
    block.innerHTML = `<div class="verse-num">Verse ${v.key}</div>
      <div class="verse-primary">${esc(v.text)}</div>
      ${ parText ? `<div class="verse-parallel">${esc(parText)}</div>` : '' }`;
    versesContainer.appendChild(block);
  }
  function renderCombinedRange(s,e, chapterArr, parArr){
    const prim = chapterArr.slice(s,e+1).map(x=>x.text).join(' ');
    const par = parArr.slice(s,e+1).map(x=>x.text).join(' ');
    versesContainer.innerHTML = `<div class="verse-block active-verse">
      <div class="verse-num">Verses ${chapterArr[s].key}${s!==e?('-'+chapterArr[e].key):''}</div>
      <div class="verse-primary">${esc(prim)}</div>
      ${ par ? `<div class="verse-parallel">${esc(par)}</div>` : '' }
    </div>`;
  }

  // reader nav visibility
  let currentVerseIndex = null;
  function showReaderNav(show, idx=null){
    readerNav.style.display = show ? 'flex' : 'none';
    currentVerseIndex = (typeof idx === 'number') ? idx : null;
  }

  // prev/next handlers
  prevVerseBtn.onclick = ()=>{
    if(currentVerseIndex === null) return;
    if(currentVerseIndex > 0){
      state.verse = normCache[state.version].books[state.bookIndex].chapters[state.chapter][currentVerseIndex-1].key;
      activateTab('read'); renderChapter(); pushState();
    } else {
      if(state.chapter > 0){ state.chapter--; const ch = normCache[state.version].books[state.bookIndex].chapters[state.chapter]; state.verse = ch[ch.length-1].key; activateTab('read'); renderChapter(); pushState(); }
    }
  };
  nextVerseBtn.onclick = ()=>{
    if(currentVerseIndex === null) return;
    const ch = normCache[state.version].books[state.bookIndex].chapters[state.chapter];
    if(currentVerseIndex < ch.length - 1){
      state.verse = ch[currentVerseIndex+1].key; activateTab('read'); renderChapter(); pushState();
    } else {
      if(state.chapter + 1 < normCache[state.version].books[state.bookIndex].chapters.length){
        state.chapter++; state.verse = normCache[state.version].books[state.bookIndex].chapters[state.chapter][0].key; activateTab('read'); renderChapter(); pushState();
      }
    }
  };
  prevChapBtn.onclick = ()=> { if(state.chapter > 0){ state.chapter--; state.verse = null; activateTab('read'); renderChapter(); pushState(); } };
  nextChapBtn.onclick = ()=> { if(state.chapter + 1 < normCache[state.version].books[state.bookIndex].chapters.length){ state.chapter++; state.verse = null; activateTab('read'); renderChapter(); pushState(); } };

  // keyboard + swipe + drag for chapter navigation
  let touchStartX = 0;
  document.addEventListener('touchstart', e=> touchStartX = e.changedTouches[0].clientX);
  document.addEventListener('touchend', e=>{
    const dx = e.changedTouches[0].clientX - touchStartX;
    if(Math.abs(dx) < 60) return;
    if(dx < 0){ if(state.chapter + 1 < normCache[state.version].books[state.bookIndex].chapters.length){ state.chapter++; state.verse=null; renderChapter(); pushState(); } }
    else { if(state.chapter > 0){ state.chapter--; state.verse=null; renderChapter(); pushState(); } }
  });

  let mouseDown=false, mouseX=0, mouseCur=0;
  versesContainer.addEventListener('mousedown', e=>{ mouseDown=true; mouseX = e.clientX; });
  document.addEventListener('mousemove', e=>{ if(!mouseDown) return; mouseCur = e.clientX; });
  document.addEventListener('mouseup', e=>{ if(!mouseDown) return; mouseDown=false; const dx = (mouseCur || e.clientX) - mouseX; if(Math.abs(dx) > 100){ if(dx < 0){ state.chapter++; state.verse=null; renderChapter(); pushState(); } else { state.chapter--; state.verse=null; renderChapter(); pushState(); } } mouseX=mouseCur=0; });

  document.addEventListener('keydown', e=>{ if(e.key === 'ArrowRight'){ if(state.chapter + 1 < normCache[state.version].books[state.bookIndex].chapters.length){ state.chapter++; state.verse=null; renderChapter(); pushState(); } } if(e.key === 'ArrowLeft'){ if(state.chapter > 0){ state.chapter--; state.verse=null; renderChapter(); pushState(); } } });

  // TTS queue (primary then parallel)
  let ttsQueue = [];
  function buildTTSQueue(){
    ttsQueue = [];
    const ch = normCache[state.version].books[state.bookIndex].chapters[state.chapter] || [];
    const pch = state.parallel && normCache[state.parallel] ? (normCache[state.parallel].books[state.bookIndex].chapters[state.chapter] || []) : [];
    if(state.verse){
      const idx = ch.findIndex(v=>v.key === state.verse);
      if(idx !== -1){ ttsQueue.push({text: ch[idx].text, idx}); if(pch[idx]) ttsQueue.push({text: pch[idx].text, idx}); return; }
      const m = state.verse.match(/^(\d+)\s*-\s*(\d+)$/);
      if(m){ const s=Number(m[1])-1,e=Number(m[2])-1; for(let i=s;i<=e;i++){ ttsQueue.push({text: ch[i].text, idx:i}); if(pch[i]) ttsQueue.push({text: pch[i].text, idx:i}); } return; }
      if(/^\d+$/.test(state.verse)){ const idx = Number(state.verse)-1; ttsQueue.push({text: ch[idx].text, idx}); if(pch[idx]) ttsQueue.push({text: pch[idx].text, idx}); return; }
      return;
    }
    for(let i=0;i<ch.length;i++){ ttsQueue.push({text: ch[i].text, idx:i}); if(pch[i]) ttsQueue.push({text: pch[i].text, idx:i}); }
  }
  function speakNext(){ if(ttsQueue.length === 0) return; const item = ttsQueue.shift(); const blocks = document.querySelectorAll('.verse-block'); blocks.forEach(b=>b.classList.remove('active-verse')); if(blocks[item.idx]){ blocks[item.idx].classList.add('active-verse'); blocks[item.idx].scrollIntoView({behavior:'smooth', block:'center'}); } const u = new SpeechSynthesisUtterance(String(item.text)); u.onend = ()=> setTimeout(speakNext, 120); u.onerror = ()=> setTimeout(speakNext, 180); speechSynthesis.speak(u); }
  ttsPlay.onclick = ()=> { speechSynthesis.cancel(); buildTTSQueue(); speakNext(); };
  ttsPause.onclick = ()=> { try{ speechSynthesis.pause(); }catch(e){} };
  ttsResume.onclick = ()=> { try{ speechSynthesis.resume(); }catch(e){} };
  ttsStop.onclick = ()=> { try{ speechSynthesis.cancel(); ttsQueue = []; }catch(e){} };

  // SEARCH
  searchBtn.onclick = async function(){
    const q = (searchBox.value || '').trim().toLowerCase();
    searchResults.innerHTML = ''; searchInfo.textContent = '';
    if(!q) return;
    const file = primarySelect.value || state.version || FILES[0];
    try{
      const norm = await fetchNorm(file);
      const idx = buildSearchIndex(file, norm);
      const results = [];
      for(let i=0;i<idx.length && results.length < 250;i++){
        if(idx[i].low.includes(q)) results.push(idx[i]);
      }
      searchInfo.textContent = `Found ${results.length}`;
      if(!results.length){ searchResults.innerHTML = '<div style="padding:8px;color:#666">No results</div>'; return; }
      const safe = q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); const re = new RegExp(safe, 'ig');
      const frag = document.createDocumentFragment();
      results.forEach(r=>{
        const div = document.createElement('div'); div.className = 'search-item';
        const snippet = esc(r.text).replace(re, m=>`<span class="highlight">${m}</span>`);
        div.innerHTML = `<strong>${esc(r.book)} ${r.chapter}:${r.verseKey}</strong><div style="margin-top:6px">${snippet}</div><small style="display:block;margin-top:6px;color:#666">Click to open</small>`;
        div.onclick = ()=> {
          state.version = file; state.bookIndex = r.bookIndex; state.chapter = r.chapterIndex; state.verse = r.verseKey; state.parallel = parallelSelect.value || null;
          activateTab('read'); awaitThenRender();
        };
        frag.appendChild(div);
      });
      searchResults.appendChild(frag);
      activateTab('search');
    }catch(e){ showNotice('Search failed: ' + e.message, 2000); }
  };

  // jump go
  jumpGo.onclick = function(){
    if(!primarySelect.value && !state.version){ showNotice('Select primary version'); return; }
    state.version = primarySelect.value || state.version || FILES[0];
    state.bookIndex = bookSelect.value !== '' ? Number(bookSelect.value) : state.bookIndex;
    state.chapter = chapterSelect.value !== '' ? Number(chapterSelect.value) : state.chapter;
    const rangeInput = (verseRange.value || '').trim();
    const viDropdown = verseSelect.value !== '' ? Number(verseSelect.value) : null;
    if(rangeInput) state.verse = rangeInput;
    else if(viDropdown !== null) state.verse = String(viDropdown + 1);
    else state.verse = null;
    state.parallel = parallelSelect.value || null;
    activateTab('read'); awaitThenRender();
  };

  // Utility: push current state to URL
  function pushState(){
    const p = new URLSearchParams();
    p.set('view', state.view);
    if(state.version) p.set('version', state.version);
    if(state.parallel) p.set('parallel', state.parallel);
    p.set('bookIndex', String(state.bookIndex));
    p.set('chapter', String(state.chapter + 1));
    if(state.verse) p.set('verse', state.verse);
    history.replaceState({...state}, '', '?' + p.toString());
  }

  // helper used by search click to await fetch then render
  async function awaitThenRender(){
    try{ await fetchNorm(state.version); if(state.parallel) await fetchNorm(state.parallel); }catch(e){}
    renderChapter(); pushState();
  }

  // render parallel pane (side-by-side)
  async function renderParallel(){
    parallelView.innerHTML = '';
    const a = primarySelect.value || state.version || FILES[0];
    const b = parallelSelect.value || state.parallel || '';
    if(!a || !b){ parallelView.innerHTML = '<div style="padding:12px;color:#666">Select both versions</div>'; return; }
    try{
      const na = await fetchNorm(a); const nb = await fetchNorm(b);
      // show first book / first chapter for preview
      const bookA = na.books[state.bookIndex] || na.books[0];
      const bookB = nb.books[state.bookIndex] || nb.books[0];
      const chA = bookA.chapters[state.chapter] || [];
      const chB = bookB.chapters[state.chapter] || [];
      // create two columns
      const wrap = document.createElement('div'); wrap.style.display='grid'; wrap.style.gridTemplateColumns='1fr 1fr'; wrap.style.gap='12px';
      const colA = document.createElement('div'); const colB = document.createElement('div');
      colA.innerHTML = `<div style="font-weight:700;margin-bottom:8px">${esc(bookA.name)} ${state.chapter+1} — ${a.replace('_bible.json','').toUpperCase()}</div>`;
      colB.innerHTML = `<div style="font-weight:700;margin-bottom:8px">${esc(bookB.name)} ${state.chapter+1} — ${b.replace('_bible.json','').toUpperCase()}</div>`;
      chA.forEach((v,i)=> colA.innerHTML += `<div style="margin-bottom:10px">${esc(v.key)}. ${esc(v.text)}</div>`);
      chB.forEach((v,i)=> colB.innerHTML += `<div style="margin-bottom:10px">${esc(v.key)}. ${esc(v.text)}</div>`);
      wrap.appendChild(colA); wrap.appendChild(colB);
      parallelView.appendChild(wrap);
    }catch(e){ parallelView.innerHTML = '<div style="padding:12px;color:#666">Load failed</div>'; }
  }

  // small helpers
  function pushAndRender(){ pushState(); renderChapter(); }
  async function initAndRender(){
    try{
      await fetchNorm(state.version);
      if(state.parallel) await fetchNorm(state.parallel);
    }catch(e){}
    renderChapter(); pushState(); renderParallel();
  }

  // event wiring
  primarySelect.onchange = async function(){
    state.version = this.value;
    showNotice(this.options[this.selectedIndex].text + ' loaded',800);
    await renderBooksPreview();
  };
  parallelSelect.onchange = function(){ state.parallel = this.value || null; renderParallel(); };

  primarySelReader.onchange = function(){ state.version = this.value; fetchNorm(state.version).then(()=>renderChapter()); primarySelect.value = this.value; };
  parallelSelReader.onchange = function(){ state.parallel = this.value || null; fetchNorm(state.parallel).then(()=>renderChapter()); parallelSelect.value = this.value || ''; };

  openBtn.onclick = function(){
    if(!primarySelect.value && !state.version){ showNotice('Select primary version'); return; }
    state.version = primarySelect.value || state.version || FILES[0];
    state.bookIndex = 0; state.chapter = 0; state.verse = null; state.parallel = parallelSelect.value || null;
    activateTab('read'); initAndRender();
  };

  // search box enter key
  searchBox.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ searchBtn.click(); } });

  // jump toggle
  jumpToggle.onclick = ()=> { const show = jumpBody.style.display === 'block'; jumpBody.style.display = show ? 'none' : 'block'; jumpBody.setAttribute('aria-hidden', show ? 'true' : 'false'); };

  // history popstate
  window.addEventListener('popstate', ev=>{
    readUrlToState();
    if(state.view) activateTab(state.view, false);
    initAndRender();
  });

  // start: set selects, prefetch minimal, then render
  if(!state.version) state.version = FILES.find(f=>f.includes('telugu')) || FILES[0];
  primarySelect.value = state.version;
  primarySelReader.value = state.version;
  if(state.parallel) { parallelSelect.value = state.parallel; parallelSelReader.value = state.parallel; }

  // bind tab initial click behavior
  activateTab(state.view || 'read', false);

  // prefetch current primary & render
  try{ await fetchNorm(state.version); if(state.parallel) await fetchNorm(state.parallel); }catch(e){}
  await renderBooksPreview();
  renderChapter();
  renderParallel();
  pushState();

  // expose small helper globally for debugging (optional)
  window._bible = {state, normCache, rawCache};

})();
</script>

</body>
</html>

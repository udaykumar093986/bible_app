<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — Index</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f7f9fc; --accent:#0b66c2; --border:#e2e8f0;
  --highlight:#fff3c4; --pulse:#ffda6b;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui}
body{background:var(--bg);color:#1d2d35;-webkit-font-smoothing:antialiased}

/* HEADER UI */
header{
  padding:14px 20px;background:#fff;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:100;
}
header .brand{font-size:22px;font-weight:700;color:var(--accent)}
header .meta{font-size:14px;color:#466}

/* MAIN LAYOUT */
main{max-width:1100px;margin:20px auto;padding:0 18px}

.controls{
  display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:14px;
}

select,input{
  padding:12px;border-radius:10px;border:1px solid var(--border);
  background:#fff;font-size:14px;min-width:140px;
}
button{
  border:0;background:var(--accent);color:#fff;
  padding:10px 18px;border-radius:10px;font-weight:600;cursor:pointer;
}

/* JUMP BOX */
.jump-container{
  background:#fff;border-radius:12px;border:1px solid var(--border);
  margin-bottom:18px;overflow:hidden;
}
.jump-header{
  padding:14px 16px;background:#f4f8ff;cursor:pointer;
  font-weight:700;color:var(--accent);
}
.jump-body{display:none;padding:14px}
.jump-body select,.jump-body input{
  margin-right:8px;padding:10px;border-radius:8px;border:1px solid var(--border)
}

/* READER PREVIEW */
.reader{
  background:#fff;border-radius:12px;border:1px solid var(--border);
  padding:18px;margin-bottom:20px;
}
.ref{font-size:22px;font-weight:700;color:var(--accent);margin-bottom:16px}

/* SEARCH RESULTS */
.search-item{
  padding:12px;border-radius:10px;border:1px solid var(--border);
  background:white;margin-bottom:10px;cursor:pointer;
}
.highlight{background:var(--highlight);padding:2px;border-radius:4px}

/* NOTICE */
.notice{
  position:fixed;top:70px;left:20px;right:20px;padding:12px;
  border-radius:10px;background:white;border:1px solid var(--border);
  text-align:center;display:none;z-index:200;
}

@media(max-width:720px){
  .controls select,input{width:100%}
  .jump-body{display:block}
}
</style>
</head>

<body>
<header>
  <div class="brand">Bible Reader</div>
  <div class="meta">PARALLEL • SEARCH • LINKS</div>
</header>

<main>
  <div class="controls">
    <select id="primarySelect"><option value="">PRIMARY VERSION</option></select>
    <select id="parallelSelect"><option value="">PARALLEL VERSION</option></select>

    <button id="openBtn">Open (First Book)</button>

    <input id="searchBox" placeholder="Search Text…" style="min-width:240px" />
    <button id="searchBtn">Search</button>
  </div>

  <div class="jump-container">
    <div class="jump-header" id="jumpToggle">▼ Jump to Book / Chapter / Verse</div>

    <div class="jump-body" id="jumpBody">
      <select id="bookSelect"><option>Book</option></select>
      <select id="chapterSelect"><option>Chapter</option></select>
      <select id="verseSelect"><option>Verse</option></select>

      <input id="verseRange" placeholder="Verse or range (e.g. 7 or 7-8)" />
      <button id="jumpGo">Go</button>
    </div>
  </div>

  <div class="reader">
    <div id="currentRef" class="ref">Choose a version and click Open or Jump/Search.</div>
    <div id="versesContainer"></div>
  </div>

  <div id="searchInfo" style="margin-bottom:6px;color:#666"></div>
  <div id="searchResults"></div>
</main>

<div id="notice" class="notice"></div>

<script>
(async function(){

const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";

const FILES = [
"AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json",
"NIV_bible.json","NKJV_bible.json","NLT_bible.json","afrikaans_bible.json",
"bengali_bible.json","gujarati_bible.json","hindi_bible.json",
"hungarian_bible.json","indonesian_bible.json","kannada_bible.json",
"malayalam_bible.json","marathi_bible.json","nepali_bible.json",
"odia_bible.json","punjabi_bible.json","sepedi_bible.json",
"tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
];

/* DOM references */
const primarySelect = document.getElementById("primarySelect");
const parallelSelect = document.getElementById("parallelSelect");
const openBtn = document.getElementById("openBtn");
const searchBox = document.getElementById("searchBox");
const searchBtn = document.getElementById("searchBtn");
const jumpToggle = document.getElementById("jumpToggle");
const jumpBody = document.getElementById("jumpBody");
const bookSelect = document.getElementById("bookSelect");
const chapterSelect = document.getElementById("chapterSelect");
const verseSelect = document.getElementById("verseSelect");
const verseRange = document.getElementById("verseRange");
const jumpGo = document.getElementById("jumpGo");
const searchResults = document.getElementById("searchResults");
const searchInfo = document.getElementById("searchInfo");
const versesContainer = document.getElementById("versesContainer");
const notice = document.getElementById("notice");

/* Fill version dropdowns */
FILES.forEach(f=>{
  const label = f.replace("_bible.json","").toUpperCase();
  primarySelect.appendChild(new Option(label, f));
  parallelSelect.appendChild(new Option(label, f));
});

/* Notice popup */
function showNotice(msg,ms=1200){
  notice.textContent = msg;
  notice.style.display="block";
  setTimeout(()=> notice.style.display="none", ms);
}

/* Normalization logic (supports 1-8 and 1-2 ranges) */
function sortVerseKeys(keys){
  return keys.sort((a,b)=>{
    const A = parseInt(String(a).split('-')[0]) || 0;
    const B = parseInt(String(b).split('-')[0]) || 0;
    return A-B;
  });
}

function normalize(json){
  if(!json) return {books:[]};

  if(json.books){
    return {
      books: json.books.map(b=>({
        name:b.name || "Unknown",
        chapters:(b.chapters||[]).map(ch=>{
          if(Array.isArray(ch)) return ch.map((t,i)=>({key:String(i+1),text:t}));
          if(typeof ch === "object"){
            const k = sortVerseKeys(Object.keys(ch));
            return k.map(v=>({key:v,text:ch[v]}));
          }
          return [];
        })
      }))
    };
  }

  const books=[];
  for(const bk of Object.keys(json)){
    const bookObj=json[bk];
    const chKeys=Object.keys(bookObj).sort((a,b)=>Number(a)-Number(b));
    books.push({
      name:bk,
      chapters:chKeys.map(ck=>{
        const ch=bookObj[ck];
        if(!ch||typeof ch!=="object") return [];
        const vkeys=sortVerseKeys(Object.keys(ch));
        return vkeys.map(v=>({key:v,text:ch[v]}));
      })
    });
  }
  return {books};
}

/* Caches */
const bibleCache={};

/* Fetch */
async function loadVersion(file){
  if(bibleCache[file]) return bibleCache[file];
  const res=await fetch(BASE + file);
  const j=await res.json();
  const norm=normalize(j);
  bibleCache[file]=norm;
  return norm;
}

/* Toggle jump box */
jumpToggle.onclick=()=>{
  jumpBody.style.display = (jumpBody.style.display==="block") ? "none" : "block";
};

/* On primary version selection */
primarySelect.onchange=async function(){
  const file=this.value;
  if(!file) return;

  const data=await loadVersion(file);
  showNotice("Loaded " + this.options[this.selectedIndex].text);

  /* Populate books */
  bookSelect.innerHTML="<option>Book</option>";
  data.books.forEach((b,i)=> bookSelect.appendChild(new Option(b.name,i)));

  chapterSelect.innerHTML="<option>Chapter</option>";
  verseSelect.innerHTML="<option>Verse</option>";
};

/* On book selection */
bookSelect.onchange=function(){
  const p=primarySelect.value;
  if(!p) return;

  const file=p;
  loadVersion(file).then(data=>{
    const bi=Number(bookSelect.value);
    const chapters=data.books[bi].chapters.length;
    chapterSelect.innerHTML="<option>Chapter</option>";
    for(let c=1;c<=chapters;c++)
      chapterSelect.appendChild(new Option(c,c-1));
  });
};

/* On chapter selection */
chapterSelect.onchange=function(){
  const p=primarySelect.value;
  if(!p) return;

  loadVersion(p).then(data=>{
    const bi=Number(bookSelect.value);
    const ci=Number(chapterSelect.value);
    const verses=data.books[bi].chapters[ci].length;
    verseSelect.innerHTML="<option>Verse</option>";
    for(let v=1;v<=verses;v++)
      verseSelect.appendChild(new Option(v,v-1));
  });
};

/* Open first chapter */
openBtn.onclick=function(){
  if(!primarySelect.value){ showNotice("Select version"); return; }
  const params=new URLSearchParams();
  params.set("version", primarySelect.value);
  params.set("bookIndex", 0);
  params.set("chapter", 1);
  window.open("read.html?" + params.toString(), "_blank");
};

/* Jump Go */
jumpGo.onclick=function(){
  if(!primarySelect.value){ showNotice("Select version"); return; }

  const bi=bookSelect.value;
  const ci=chapterSelect.value;
  const verse=verseRange.value || (verseSelect.value ? Number(verseSelect.value)+1 : null);

  const params=new URLSearchParams();
  params.set("version", primarySelect.value);
  params.set("bookIndex", bi);
  params.set("chapter", Number(ci)+1);

  if(verse) params.set("verse", verse);

  window.open("read.html?" + params.toString(), "_blank");
};

/* SEARCH */
searchBtn.onclick=async function(){
  const q=(searchBox.value || "").trim().toLowerCase();
  searchResults.innerHTML=""; searchInfo.textContent="";

  if(!q) return;
  if(!primarySelect.value){ searchInfo.textContent="Select version first"; return; }

  const file=primarySelect.value;
  const data=await loadVersion(file);

  const index=[];
  data.books.forEach((b,bi)=>{
    b.chapters.forEach((ch,ci)=>{
      ch.forEach((v,vi)=>{
        const t=(v && v.text) ? v.text.toLowerCase() : "";
        index.push({
          book:b.name, bookIndex:bi,
          chapter:ci+1, chapterIndex:ci,
          verseKey:v.key, verseIndex:vi,
          text:v.text, low:t
        });
      });
    });
  });

  const results=index.filter(x=>x.low.includes(q));
  searchInfo.textContent="Found " + results.length;

  if(!results.length){
    searchResults.innerHTML="<div>No results</div>";
    return;
  }

  const safe=q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
  const re=new RegExp(safe,"ig");

  results.forEach(r=>{
    const div=document.createElement("div");
    div.className="search-item";
    div.innerHTML=`
      <strong>${r.book} ${r.chapter}:${r.verseKey}</strong>
      <div>${(r.text||"").replace(re,m=>"<span class='highlight'>"+m+"</span>")}</div>
    `;
    div.onclick=()=>{
      const params=new URLSearchParams();
      params.set("version", primarySelect.value);
      params.set("bookIndex", r.bookIndex);
      params.set("chapter", r.chapter);
      params.set("verse", r.verseKey);
      window.open("read.html?" + params, "_blank");
    };
    searchResults.appendChild(div);
  });

};

})();
</script>
</body>
</html>

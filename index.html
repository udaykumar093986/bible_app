<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — Parallel + TTS + Jump Menu</title>

<!-- Bible-Friendly Font -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --muted:#223;
    --accent:#0b66c2;
    --border:#e9eef6;
    --soft:#f6fbff;
    --highlight:#fff2b8;
    --pulse:#ffd65a;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Arial;
    background:var(--bg);color:var(--muted);
  }

  header{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 16px;border-bottom:1px solid var(--border);
    background:var(--card);position:sticky;top:0;z-index:60;
  }
  .brand{font-weight:700;color:var(--accent)}

  main{
    max-width:980px;margin:14px auto;padding:0 14px;
  }

  /* TOP CONTROLS */
  .controls{
    display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;
  }
  select,input{
    padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:14px;
  }
  button{
    padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;
    cursor:pointer;font-size:13px;font-weight:600;
  }

  /* SMALL TTS BUTTONS */
  .tts-small-bar{
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    margin-top:6px;margin-bottom:10px;
  }
  .tts-btn{
    background:#0b66c2;
    padding:8px 12px;
    border-radius:8px;
    font-size:13px;
  }

  /* COLLAPSIBLE JUMP MENU */
  .jump-container{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    margin-bottom:14px;
    overflow:hidden;
  }
  .jump-header{
    padding:12px 14px;
    background:#f3f7ff;
    font-weight:700;
    color:var(--accent);
    cursor:pointer;
    user-select:none;
  }
  .jump-body{
    display:none;
    padding:14px;
    background:#ffffff;
    border-top:1px solid var(--border);
  }

  .jump-body select{
    min-width:120px;
  }

  /* READER */
  .reader{
    background:var(--card);
    border:1px solid var(--border);
    padding:14px;border-radius:12px;
  }
  .ref{font-weight:700;font-size:20px;color:var(--accent);margin-bottom:12px}

  .verse-block{
    padding:14px;border-radius:12px;margin-bottom:12px;
    background:var(--soft);
    border:1px solid var(--border);
    transition:all .3s ease;
  }
  .verse-num{font-weight:700;color:#345;font-size:14px;margin-bottom:6px}

  .verse-primary{
    font-family:"Noto Serif",serif;font-size:18px;line-height:1.75;color:#1b1b1b;
  }
  .verse-parallel{
    margin-top:10px;padding-left:14px;border-left:3px solid var(--accent);
    font-family:"Noto Serif",serif;font-size:17px;line-height:1.7;color:#2e3f55;
  }

  .active-verse{
    background:#fff9d6 !important;
    border:2px solid var(--pulse) !important;
    animation:pulseGlow 1.4s infinite ease-in-out;
  }
  @keyframes pulseGlow{
    0%{box-shadow:0 0 0px var(--pulse)}
    50%{box-shadow:0 0 14px var(--pulse)}
    100%{box-shadow:0 0 0px var(--pulse)}
  }

  /* Search */
  .search-item{
    background:#fff;border:1px solid var(--border);
    padding:10px;border-radius:10px;margin-bottom:10px;cursor:pointer;
  }
  .highlight{background:var(--highlight);padding:2px;border-radius:4px}

  /* Notice popup */
  .notice{
    position:fixed;top:76px;left:10px;right:10px;
    padding:10px;background:#fff;border:1px solid #ddd;
    border-radius:10px;text-align:center;z-index:100;display:none;
  }

  /* RESPONSIVE */
  @media(max-width:640px){
    .controls{flex-direction:column}
    select,input,button{width:100%}
  }
</style>
</head>

<body>

<header>
  <div class="brand">Bible Reader</div>
  <div style="color:#678;font-size:13px;">Parallel + TTS</div>
</header>

<main>

  <!-- TOP CONTROLS -->
  <div class="controls">
    <select id="primarySelect"><option value="">PRIMARY VERSION</option></select>
    <select id="parallelSelect"><option value="">PARALLEL VERSION</option></select>
    <button id="openBtn">Open</button>
    <input id="searchBox" placeholder="Search…" />
    <button id="searchBtn">Search</button>
    <select id="voiceSelect"></select>
  </div>

  <!-- SMALL TTS BUTTONS -->
  <div class="tts-small-bar">
    <button id="ttsPlay" class="tts-btn">▶ Play</button>
    <button id="ttsPause" class="tts-btn">⏸ Pause</button>
    <button id="ttsResume" class="tts-btn">⏯ Resume</button>
    <button id="ttsStop" class="tts-btn">⏹ Stop</button>
  </div>

  <!-- COLLAPSIBLE JUMP MENU (OPTION C) -->
  <div class="jump-container">
    <div class="jump-header" id="jumpToggle">▼ Jump to Book / Chapter / Verse</div>

    <div class="jump-body" id="jumpBody">
      <select id="bookSelect"><option value="">Book</option></select>
      <select id="chapterSelect"><option value="">Chapter</option></select>
      <select id="verseSelect"><option value="">Verse</option></select>
      <button id="jumpGo">Go</button>
    </div>
  </div>

  <!-- READER -->
  <div class="reader">
    <div id="currentRef" class="ref"></div>
    <div id="versesContainer"></div>
  </div>

  <!-- SEARCH RESULTS -->
  <div style="margin-top:12px">
    <div id="searchInfo" style="color:#678;margin-bottom:6px"></div>
    <div id="searchResults"></div>
  </div>
</main>

<div id="notice" class="notice"></div>

<script>
/* =============================
   SAME JS ENGINE AS BEFORE
   + JUMP MENU LOGIC ADDED
   + SMALL TTS BUTTONS INCLUDED
============================= */

/* CDN Bible Versions */
const BASE="https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";
const FILES=[
 "AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json","NIV_bible.json",
 "NKJV_bible.json","NLT_bible.json","afrikaans_bible.json","bengali_bible.json","gujarati_bible.json",
 "hindi_bible.json","hungarian_bible.json","indonesian_bible.json","kannada_bible.json","malayalam_bible.json",
 "marathi_bible.json","nepali_bible.json","odia_bible.json","punjabi_bible.json","sepedi_bible.json",
 "tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
];

const versionMap={};
FILES.forEach(f=>{
  const label=f.replace("_bible.json","").toUpperCase();
  versionMap[label]=f;
});

/* DOM */
const primarySelect=document.getElementById("primarySelect");
const parallelSelect=document.getElementById("parallelSelect");
const openBtn=document.getElementById("openBtn");
const searchBox=document.getElementById("searchBox");
const searchBtn=document.getElementById("searchBtn");
const versesContainer=document.getElementById("versesContainer");
const currentRef=document.getElementById("currentRef");
const searchResults=document.getElementById("searchResults");
const searchInfo=document.getElementById("searchInfo");
const notice=document.getElementById("notice");

const ttsPlay=document.getElementById("ttsPlay");
const ttsPause=document.getElementById("ttsPause");
const ttsResume=document.getElementById("ttsResume");
const ttsStop=document.getElementById("ttsStop");
const voiceSelect=document.getElementById("voiceSelect");

/* Jump menu elements */
const jumpToggle=document.getElementById("jumpToggle");
const jumpBody=document.getElementById("jumpBody");
const bookSelect=document.getElementById("bookSelect");
const chapterSelect=document.getElementById("chapterSelect");
const verseSelect=document.getElementById("verseSelect");
const jumpGo=document.getElementById("jumpGo");

jumpToggle.onclick=()=>{
  jumpBody.style.display = jumpBody.style.display==="block" ? "none" : "block";
};

/* State */
const bibleCache={};
const searchIndex={};
let current={version:null,parallel:null,book:0,chapter:0};

function showNotice(msg,ms=1500){
  notice.textContent=msg;
  notice.style.display="block";
  setTimeout(()=>notice.style.display="none",ms);
}
function esc(s){return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;")}

/* Populate Version Dropdowns */
Object.keys(versionMap).forEach(v=>{
  primarySelect.appendChild(new Option(v,v));
  parallelSelect.appendChild(new Option(v,v));
});

/* LOAD + NORMALIZE (same engine as previous messages, unchanged for stability) */
async function loadVersion(label){
  if(bibleCache[label]) return bibleCache[label];
  const res=await fetch(BASE+versionMap[label]);
  const j=await res.json();
  const n=normalize(j);
  bibleCache[label]=n;
  buildIndex(label,n);
  return n;
}

function normalize(json){
  const out={books:[]};
  if(json.books){
    out.books=json.books.map(b=>({name:b.name||b.book,chapters:b.chapters.map(c=>Array.isArray(c)?c:Object.values(c))}));
    return out;
  }
  for(const name in json){
    const bk=json[name];
    const chapters=[];
    if(bk.chapters){
      bk.chapters.forEach(ch=>chapters.push(Array.isArray(ch)?ch:Object.values(ch)));
    } else {
      Object.keys(bk).sort((a,b)=>a-b).forEach(k=>{
        chapters.push(Array.isArray(bk[k])?bk[k]:Object.values(bk[k]));
      });
    }
    out.books.push({name,chapters});
  }
  return out;
}

function buildIndex(label,n){
  const idx=[];
  n.books.forEach((b,bi)=>{
    b.chapters.forEach((ch,ci)=>{
      ch.forEach((v,vi)=>{
        idx.push({bookIndex:bi,chapterIndex:ci,verseIndex:vi,
          book:b.name,chapter:ci+1,verse:vi+1,text:v.toString(),low:v.toString().toLowerCase()});
      });
    });
  });
  searchIndex[label]=idx;
}

/* RENDER CHAPTER */
function renderChapter(){
  const b=bibleCache[current.version].books[current.book];
  const primary=b.chapters[current.chapter];
  let parallel=null;

  if(current.parallel && bibleCache[current.parallel]){
    parallel=bibleCache[current.parallel].books[current.book].chapters[current.chapter];
  }

  currentRef.textContent=`${b.name} ${current.chapter+1}`;

  let html="";
  for(let i=0;i<primary.length;i++){
    html+=`
    <div class="verse-block" id="v-${i}">
      <div class="verse-num">Verse ${i+1}</div>
      <div class="verse-primary">${esc(primary[i])}</div>
      ${parallel?`<div class="verse-parallel">${esc(parallel[i]||"")}</div>`:""}
    </div>`;
  }
  versesContainer.innerHTML=html;

  populateChapters();
  populateVerses();
}

/* SEARCH */
async function doSearch(){
  const q=searchBox.value.trim().toLowerCase();
  if(!q) return;
  if(!current.version){searchInfo.textContent="Select version first";return;}

  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);

  const idx=searchIndex[current.version];
  const results=idx.filter(r=>r.low.includes(q)).slice(0,200);
  searchInfo.textContent=`Found ${results.length}`;

  let out="";
  const safe=q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
  const re=new RegExp(safe,"ig");

  results.forEach(r=>{
    let prim=esc(r.text).replace(re,m=>`<span class='highlight'>${m}</span>`);
    let par="";

    if(current.parallel){
      const pv=bibleCache[current.parallel].books[r.bookIndex].chapters[r.chapterIndex][r.verseIndex];
      if(pv) par=esc(pv).replace(re,m=>`<span class='highlight'>${m}</span>`);
    }

    out+=`
      <div class="search-item" onclick="openResult(${r.bookIndex},${r.chapterIndex},${r.verseIndex})">
        <strong>${r.book} ${r.chapter}:${r.verse}</strong>
        <div>${prim}</div>
        ${par?`<div style='margin-top:6px;color:#345'>${par}</div>`:""}
      </div>`;
  });

  searchResults.innerHTML=out;
}

/* OPEN SEARCH RESULT */
window.openResult=async function(bi,ci,vi){
  current.book=bi;current.chapter=ci;
  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);

  renderChapter();

  setTimeout(()=>{
    const el=document.getElementById("v-"+vi);
    if(el){
      el.classList.add("active-verse");
      el.scrollIntoView({behavior:"smooth",block:"center"});
      setTimeout(()=>el.classList.remove("active-verse"),3000);
    }
  },200);
};

/* =============================
   JUMP MENU LOGIC
============================= */
function populateBooks(){
  bookSelect.innerHTML="<option value=''>Book</option>";
  const books=bibleCache[current.version].books;
  books.forEach((b,i)=> bookSelect.appendChild(new Option(b.name,i)));
}
function populateChapters(){
  chapterSelect.innerHTML="<option value=''>Chapter</option>";
  const chapters=bibleCache[current.version].books[current.book].chapters.length;
  for(let i=1;i<=chapters;i++){
    chapterSelect.appendChild(new Option(i,i-1));
  }
}
function populateVerses(){
  verseSelect.innerHTML="<option value=''>Verse</option>";
  const verses=bibleCache[current.version].books[current.book].chapters[current.chapter].length;
  for(let i=1;i<=verses;i++){
    verseSelect.appendChild(new Option(i,i-1));
  }
}

bookSelect.onchange=()=>{
  current.book=Number(bookSelect.value);
  populateChapters();
  verseSelect.innerHTML="<option>Verse</option>";
};
chapterSelect.onchange=()=>{
  current.chapter=Number(chapterSelect.value);
  populateVerses();
};
jumpGo.onclick=()=>{
  if(bookSelect.value===""||chapterSelect.value==="") return;
  renderChapter();
  if(verseSelect.value!==""){
    const vi=Number(verseSelect.value);
    setTimeout(()=>{
      const el=document.getElementById("v-"+vi);
      if(el){
        el.classList.add("active-verse");
        el.scrollIntoView({behavior:"smooth",block:"center"});
      }
    },200);
  }
};

/* =============================
   SMALL TTS ENGINE
============================= */
let queue=[];
function buildQueue(){
  queue=[];
  const b=bibleCache[current.version].books[current.book];
  const primary=b.chapters[current.chapter];
  let parallel=null;

  if(current.parallel){
    parallel=bibleCache[current.parallel].books[current.book].chapters[current.chapter];
  }

  for(let i=0;i<primary.length;i++){
    queue.push({text:primary[i],index:i});
    if(parallel) queue.push({text:parallel[i],index:i,parallel:true});
    queue.push({pause:true,ms:220});
  }
}

function highlightVerse(i){
  document.querySelectorAll(".active-verse").forEach(el=>el.classList.remove("active-verse"));
  const el=document.getElementById("v-"+i);
  if(el){
    el.classList.add("active-verse");
    el.scrollIntoView({behavior:"smooth",block:"center"});
  }
}

function speakNext(){
  if(queue.length===0) return;
  const item=queue.shift();
  if(item.pause){ setTimeout(speakNext,item.ms); return; }

  highlightVerse(item.index);
  const utt=new SpeechSynthesisUtterance(item.text);
  const v=speechSynthesis.getVoices().find(v=>v.name===voiceSelect.value);
  if(v) utt.voice=v;
  utt.onend=()=>setTimeout(speakNext,150);
  speechSynthesis.speak(utt);
}

ttsPlay.onclick=async ()=>{
  if(!current.version){showNotice("Open chapter first");return;}
  speechSynthesis.cancel();
  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);
  buildQueue();
  speakNext();
};
ttsPause.onclick=()=>speechSynthesis.pause();
ttsResume.onclick=()=>speechSynthesis.resume();
ttsStop.onclick=()=>{speechSynthesis.cancel();queue=[]};

/* Load voices */
function loadVoices(){
  voiceSelect.innerHTML="";
  voiceSelect.appendChild(new Option("Default",""));
  speechSynthesis.getVoices().forEach(v=>{
    voiceSelect.appendChild(new Option(v.name,v.name));
  });
}
speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

/* =============================
   EVENTS
============================= */
primarySelect.onchange=async ()=>{
  current.version=primarySelect.value;
  await loadVersion(current.version);
  populateBooks();
};

parallelSelect.onchange=async()=>{
  current.parallel=parallelSelect.value||null;
  if(current.parallel) await loadVersion(current.parallel);
};

openBtn.onclick=async()=>{
  if(!current.version)return;
  current.book=0;current.chapter=0;
  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);
  renderChapter();
};

searchBtn.onclick=doSearch;
searchBox.onkeydown=e=>{ if(e.key==="Enter") doSearch(); };

versesContainer.innerHTML="<div>Select PRIMARY version, then click OPEN.</div>";
</script>

</body>
</html>

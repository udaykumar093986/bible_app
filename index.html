<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader â€” Parallel + Search + TTS + Highlight Animation</title>

<!-- Bible-Friendly Font -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --muted:#223;
    --accent:#0b66c2;
    --border:#e9eef6;
    --soft:#f6fbff;
    --highlight:#fff2b8;
    --pulse:#ffd65a;
  }

  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,Arial;
    background:var(--bg);color:var(--muted);
    -webkit-font-smoothing:antialiased;
  }

  header{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 16px;border-bottom:1px solid var(--border);
    background:var(--card);position:sticky;top:0;z-index:50;
  }

  .brand{font-weight:700;color:var(--accent)}

  main{max-width:980px;margin:14px auto;padding:0 14px}

  .controls{
    display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;
  }

  select,input{
    padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;
  }
  button{
    padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;
    font-size:14px;font-weight:600;cursor:pointer;
  }

  .reader{
    background:var(--card);border:1px solid var(--border);
    padding:14px;border-radius:12px;
  }

  .ref{
    font-weight:700;font-size:20px;color:var(--accent);margin-bottom:12px;
  }

  .verse-block{
    padding:14px;border-radius:12px;margin-bottom:12px;
    background:var(--soft);border:1px solid var(--border);
    transition:all .3s ease;
  }

  .verse-num{font-weight:700;color:#345;font-size:14px;margin-bottom:6px}

  .verse-primary{
    font-family:"Noto Serif",serif;font-size:18px;line-height:1.75;color:#1b1b1b;
  }

  .verse-parallel{
    margin-top:10px;padding-left:14px;border-left:3px solid var(--accent);
    font-family:"Noto Serif",serif;font-size:17px;line-height:1.7;color:#2e3f55;
  }

  /* ðŸ”¥ Highlight Animation */
  .active-verse{
    background:#fff9d6 !important;
    border:2px solid var(--pulse) !important;
    animation:pulseGlow 1.4s infinite ease-in-out;
  }

  @keyframes pulseGlow{
    0%{box-shadow:0 0 0px var(--pulse)}
    50%{box-shadow:0 0 14px var(--pulse)}
    100%{box-shadow:0 0 0px var(--pulse)}
  }

  /* Search */
  .search-item{
    background:#fff;border:1px solid var(--border);
    padding:10px;border-radius:10px;margin-bottom:10px;cursor:pointer;
  }
  .highlight{background:#fff2b8;padding:2px;border-radius:4px}

  /* Notice */
  .notice{
    position:fixed;top:70px;left:10px;right:10px;padding:10px;
    background:#fff;border:1px solid #ddd;border-radius:10px;
    text-align:center;z-index:100;display:none;
  }

  /* TTS controls */
  .tts-controls{display:flex;gap:8px;flex-wrap:wrap}
  #voiceSelect{min-width:180px}

  /* Responsive */
  @media(max-width:640px){
    .controls{flex-direction:column}
    select,input,button{width:100%}
    .verse-primary{font-size:17px}
    .verse-parallel{font-size:16px}
  }
</style>
</head>

<body>

<header>
  <div class="brand">Bible Reader â€” Parallel + TTS</div>
  <div style="color:#678;font-size:13px;">Final Build</div>
</header>

<main>

  <!-- Controls -->
  <div class="controls">
    <select id="primarySelect"><option value="">PRIMARY VERSION</option></select>
    <select id="parallelSelect"><option value="">PARALLEL VERSION</option></select>

    <button id="openBtn">OPEN</button>

    <input id="searchBox" placeholder="Searchâ€¦" />
    <button id="searchBtn">Search</button>

    <div class="tts-controls">
      <select id="voiceSelect"></select>
      <button id="ttsPlay">Play</button>
      <button id="ttsPause">Pause</button>
      <button id="ttsResume">Resume</button>
      <button id="ttsStop">Stop</button>
    </div>
  </div>

  <!-- Reader Section -->
  <div class="reader">
    <div id="currentRef" class="ref"></div>
    <div id="versesContainer"></div>
  </div>

  <!-- Search -->
  <div>
    <div id="searchInfo" style="margin-top:8px;color:#678"></div>
    <div id="searchResults"></div>
  </div>

</main>

<div id="notice" class="notice"></div>

<script>
/* =============================
   CONFIG
============================= */
const BASE="https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";

const FILES=[
  "AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json","NIV_bible.json",
  "NKJV_bible.json","NLT_bible.json","afrikaans_bible.json","bengali_bible.json",
  "gujarati_bible.json","hindi_bible.json","hungarian_bible.json","indonesian_bible.json",
  "kannada_bible.json","malayalam_bible.json","marathi_bible.json","nepali_bible.json",
  "odia_bible.json","punjabi_bible.json","sepedi_bible.json","tamil_bible.json",
  "telugu_bible.json","xhosa_bible.json","zulu_bible.json"
];

const versionMap={};
FILES.forEach(f=>{
  const label=f.replace("_bible.json","").toUpperCase();
  versionMap[label]=f;
});

/* =============================
   DOM
============================= */
const primarySelect=document.getElementById("primarySelect");
const parallelSelect=document.getElementById("parallelSelect");
const openBtn=document.getElementById("openBtn");
const searchBox=document.getElementById("searchBox");
const searchBtn=document.getElementById("searchBtn");
const versesContainer=document.getElementById("versesContainer");
const currentRef=document.getElementById("currentRef");
const searchResults=document.getElementById("searchResults");
const searchInfo=document.getElementById("searchInfo");
const notice=document.getElementById("notice");

const ttsPlay=document.getElementById("ttsPlay");
const ttsPause=document.getElementById("ttsPause");
const ttsResume=document.getElementById("ttsResume");
const ttsStop=document.getElementById("ttsStop");
const voiceSelect=document.getElementById("voiceSelect");

const bibleCache={};
const searchIndex={};
let current={version:null,parallel:null,book:0,chapter:0};

/* =============================
   UTIL
============================= */
function showNotice(msg,time=1500){
  notice.textContent=msg;
  notice.style.display="block";
  setTimeout(()=>notice.style.display="none",time);
}
function esc(s){return s.replaceAll("&","&amp;").replaceAll("<","&lt;")}

/* =============================
   Populate Version Dropdowns
============================= */
Object.keys(versionMap).forEach(v=>{
  primarySelect.appendChild(new Option(v,v));
  parallelSelect.appendChild(new Option(v,v));
});

/* =============================
   Load & Normalize JSON
============================= */
async function loadVersion(label){
  if(bibleCache[label]) return bibleCache[label];
  const url=BASE+versionMap[label];
  const res=await fetch(url);
  const json=await res.json();
  bibleCache[label]=normalize(json);
  buildIndex(label,bibleCache[label]);
  return bibleCache[label];
}

function normalize(json){
  const out={books:[]};
  if(json.books){
    out.books=json.books.map(b=>({
      name:b.name || b.book,
      chapters:b.chapters.map(c=>Array.isArray(c)?c:Object.values(c))
    }));
    return out;
  }
  for(const name in json){
    const bk=json[name];
    const chapters=[];
    if(bk.chapters){
      bk.chapters.forEach(ch=> chapters.push(Array.isArray(ch)?ch:Object.values(ch)));
    } else {
      Object.keys(bk).forEach(ch=>{
        chapters.push(Array.isArray(bk[ch])?bk[ch]:Object.values(bk[ch]));
      });
    }
    out.books.push({name,chapters});
  }
  return out;
}

/* =============================
   Search Index
============================= */
function buildIndex(label,data){
  const idx=[];
  data.books.forEach((b,bi)=>{
    b.chapters.forEach((ch,ci)=>{
      ch.forEach((v,vi)=>{
        idx.push({
          bookIndex:bi,chapterIndex:ci,verseIndex:vi,
          book:b.name,
          chapter:ci+1,
          verse:vi+1,
          text:v.toString(),
          low:v.toString().toLowerCase()
        });
      });
    });
  });
  searchIndex[label]=idx;
}

/* =============================
   Render Chapter with Parallel
============================= */
function renderChapter(){
  const p=bibleCache[current.version].books[current.book];
  const primary=p.chapters[current.chapter];

  let parallel=null;
  if(current.parallel){
    parallel=bibleCache[current.parallel].books[current.book].chapters[current.chapter];
  }

  currentRef.textContent=`${p.name} ${current.chapter+1}`;

  let out="";
  for(let i=0;i<primary.length;i++){
    out+=`
      <div class="verse-block" id="v-${i}">
        <div class="verse-num">Verse ${i+1}</div>
        <div class="verse-primary">${esc(primary[i])}</div>
        ${parallel?`<div class="verse-parallel">${esc(parallel[i]||"")}</div>`:""}
      </div>`;
  }

  versesContainer.innerHTML=out;
}

/* =============================
   Search
============================= */
async function doSearch(){
  const q=searchBox.value.trim().toLowerCase();
  if(!q) return;

  if(!current.version){ searchInfo.textContent="Select a version first"; return;}

  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);

  const idx=searchIndex[current.version];
  const safe=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const re=new RegExp(safe,"ig");

  const results=idx.filter(v=>v.low.includes(q)).slice(0,200);

  searchInfo.textContent=`Found ${results.length}`;
  let out="";

  results.forEach(r=>{
    let primary=esc(r.text).replace(re,m=>`<span class='highlight'>${m}</span>`);
    let parallel="";

    if(current.parallel){
      const pv=bibleCache[current.parallel].books[r.bookIndex].chapters[r.chapterIndex][r.verseIndex];
      if(pv) parallel=esc(pv).replace(re,m=>`<span class='highlight'>${m}</span>`);
    }

    out+=`
      <div class="search-item" onclick="openResult(${r.bookIndex},${r.chapterIndex},${r.verseIndex})">
        <strong>${r.book} ${r.chapter}:${r.verse}</strong>
        <div>${primary}</div>
        ${parallel?`<div style='margin-top:6px;color:#345'>${parallel}</div>`:""}
        <small>Open verse</small>
      </div>`;
  });

  searchResults.innerHTML=out;
}

window.openResult=async function(bi,ci,vi){
  current.book=bi;
  current.chapter=ci;

  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);

  renderChapter();

  setTimeout(()=>{
    const el=document.getElementById("v-"+vi);
    if(el){
      el.classList.add("active-verse");
      el.scrollIntoView({behavior:"smooth",block:"center"});
      setTimeout(()=>el.classList.remove("active-verse"),3500);
    }
  },200);
}

/* =============================
   TTS + Highlight Animation
============================= */
let queue=[];
function buildQueue(){
  queue=[];
  const p=bibleCache[current.version].books[current.book];
  const primary=p.chapters[current.chapter];

  let parallel=null;
  if(current.parallel){
    parallel=bibleCache[current.parallel].books[current.book].chapters[current.chapter];
  }

  for(let i=0;i<primary.length;i++){
    queue.push({text:primary[i],index:i});
    if(parallel) queue.push({text:parallel[i],index:i,parallel:true});
    queue.push({pause:true,ms:220});
  }
}

function highlight(i){
  document.querySelectorAll(".active-verse").forEach(el=>el.classList.remove("active-verse"));
  const el=document.getElementById("v-"+i);
  if(el){
    el.classList.add("active-verse");
    el.scrollIntoView({behavior:"smooth",block:"center"});
  }
}

function speakNext(){
  if(queue.length===0) return;

  const item=queue.shift();

  if(item.pause){
    setTimeout(speakNext,item.ms);
    return;
  }

  highlight(item.index);

  const utter=new SpeechSynthesisUtterance(item.text);
  let v=speechSynthesis.getVoices().find(v=>v.name===voiceSelect.value);
  if(v) utter.voice=v;

  utter.rate=1.0;
  utter.onend=()=> setTimeout(speakNext,150);

  speechSynthesis.speak(utter);
}

ttsPlay.onclick=async ()=>{
  if(!current.version){ showNotice("Open a chapter first"); return; }
  speechSynthesis.cancel();
  buildQueue();
  speakNext();
};

ttsPause.onclick=()=>speechSynthesis.pause();
ttsResume.onclick=()=>speechSynthesis.resume();
ttsStop.onclick=()=>speechSynthesis.cancel();

function loadVoices(){
  voiceSelect.innerHTML="";
  voiceSelect.appendChild(new Option("Default Voice",""));
  speechSynthesis.getVoices().forEach(v=>{
    voiceSelect.appendChild(new Option(v.name,v.name));
  });
}
speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

/* =============================
   UI Events
============================= */
primarySelect.onchange=async()=>{
  current.version=primarySelect.value;
  await loadVersion(current.version);
};

parallelSelect.onchange=async()=>{
  current.parallel=parallelSelect.value||null;
  if(current.parallel) await loadVersion(current.parallel);
};

openBtn.onclick=async()=>{
  if(!current.version){ showNotice("Select primary version"); return;}
  current.book=0;current.chapter=0;
  await loadVersion(current.version);
  if(current.parallel) await loadVersion(current.parallel);
  renderChapter();
};

searchBtn.onclick=doSearch;
searchBox.onkeydown=e=>{ if(e.key==="Enter") doSearch(); };

versesContainer.innerHTML="<div>Select versions and open a chapter.</div>";

</script>

</body>
</html>

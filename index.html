<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Bible Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7f9fc; --card:#ffffff; --accent:#0b66c2; --muted:#6f7f8b;
  --border:#e6eef6; --radius:12px; --maxwidth:1100px; --pad:18px;
  --text:#102027; --verse-bg:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-font-smoothing:antialiased}
.header{position:sticky;top:0;z-index:120;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 18px;gap:10px}
.brand{font-weight:800;color:var(--accent);font-size:20px;display:flex;align-items:center;gap:10px}
.tabbar{display:flex;gap:8px;align-items:center}
.tab{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;color:var(--muted);font-weight:700;cursor:pointer;white-space:nowrap}
.tab.active{background:#eaf6ff;color:var(--accent);box-shadow:0 1px 6px rgba(11,102,194,0.06)}
.container{max-width:var(--maxwidth);margin:18px auto;padding:0 18px;display:flex;flex-direction:column;gap:18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
.select,input[type="text"]{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card);font-size:14px}
button.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
.small-btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
.home-card{display:flex;flex-direction:column;gap:12px;max-width:880px;margin:0 auto}
.home-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.reader-ref{font-size:22px;font-weight:800;color:var(--accent);margin:8px 0}
.verse-block{background:var(--card);border-radius:12px;border:1px solid var(--border);padding:14px;margin-bottom:12px}
.verse-num{font-weight:800;color:#355;margin-bottom:8px;font-size:13px}
.verse-text{font-family:"Noto Serif",serif;font-size:18px;line-height:1.75;color:#111;margin-bottom:8px}
.verse-label{font-weight:700;color:#0b66c2;margin-top:6px;margin-bottom:6px}
.verse-secondary{font-family:"Noto Serif",serif;font-size:17px;line-height:1.6;color:#2a3c55;margin-top:6px;padding-left:6px;border-left:3px solid #eef6fc}
.search-item{padding:12px;border-radius:10px;border:1px solid var(--border);background:#fff;margin-bottom:10px;cursor:pointer}
.highlight{background:#fff3c4;padding:2px;border-radius:4px}
.parallel-container{max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
.nav-row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
.notice{position:fixed;left:16px;right:16px;top:74px;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;text-align:center;display:none;z-index:500;color:var(--text)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(255,255,255,0.98);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;padding:6px 10px;z-index:200;transition:transform .28s ease,opacity .28s ease}
.bottom-nav.hidden{transform:translateY(100%);opacity:0}
.bottom-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);font-weight:700;font-size:13px;cursor:pointer;padding:6px 8px;border-radius:8px}
.bottom-item.active{color:var(--accent)}
@media(min-width:1000px){ .bottom-nav{display:none} }
@media(max-width:999px){ .reader-ref{font-size:18px} .verse-text{font-size:16px} }
@media(max-width:700px){ .header{padding:10px 12px} .tab{padding:6px 8px;font-size:13px} .verse-text{font-size:15px} .verse-secondary{font-size:15px} .home-row{flex-direction:column;align-items:stretch} .nav-row{flex-direction:column;align-items:stretch} }
@media(min-width:1200px){ .parallel-container{display:grid;grid-template-columns:1fr 1fr;gap:18px} .verse-block.parallel{padding:12px} }
@supports (padding: max(0px)){ .bottom-nav{padding-bottom:calc(env(safe-area-inset-bottom) + 6px);height:calc(64px + env(safe-area-inset-bottom));} }
</style>
</head>
<body>
<header class="header">
  <div class="brand">üìò Bible Reader</div>
  <nav class="tabbar" role="navigation" aria-label="Top tabs">
    <div class="tab active" id="tab-home" data-tab="home">üè† HOME</div>
    <div class="tab" id="tab-read" data-tab="read">üìñ READ</div>
    <div class="tab" id="tab-search" data-tab="search">üîé SEARCH</div>
    <div class="tab" id="tab-parallel" data-tab="parallel">üìö PARALLEL</div>
  </nav>
</header>

<main class="container" id="app" style="padding-bottom:92px">
  <section id="pane-home" class="card pane show" aria-label="Home">
    <div class="home-card">
      <div style="flex:1">
        <div style="font-weight:800;color:#083a5e;margin-bottom:10px">Open a passage</div>
        <div class="home-row">
          <label for="homeVersion">Version</label>
          <select id="homeVersion" class="select"><option value="">SELECT VERSION</option></select>
        </div>
        <div class="home-row">
          <label for="homeBook">Passage</label>
          <select id="homeBook" class="select"><option value="">Book</option></select>
          <select id="homeChapter" class="select"><option value="">Chapter</option></select>
          <select id="homeVerse" class="select"><option value="">Verse</option></select>
        </div>
        <div class="home-row">
          <label></label>
          <input id="homeRange" class="select" placeholder="Optional range (e.g. 7-8)" />
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="homeOpen" class="btn">OPEN</button>
      </div>
    </div>
  </section>

  <section id="pane-read" class="card pane" aria-label="Read" style="display:none">
    <div class="reader-top">
      <button id="play" class="small-btn">‚ñ∂ Play</button>
      <button id="pause" class="small-btn">‚è∏ Pause</button>
      <button id="resume" class="small-btn">‚èØ Resume</button>
      <button id="stop" class="small-btn">‚èπ Stop</button>
      <div style="flex:1"></div>
    </div>

    <div class="nav-row" id="readNav" style="display:none">
      <button id="prevVerse" class="small-btn">‚óÄ Prev Verse</button>
      <button id="nextVerse" class="small-btn">Next Verse ‚ñ∂</button>
      <button id="prevChapter" class="small-btn">‚óÄ Prev Chapter</button>
      <button id="nextChapter" class="small-btn">Next Chapter ‚ñ∂</button>
    </div>

    <div id="readRef" class="reader-ref"></div>
    <div id="readVerses" tabindex="0"></div>
  </section>

  <section id="pane-search" class="card pane" aria-label="Search" style="display:none">
    <div style="margin-bottom:10px">
      <input id="searchBox" placeholder="Search current version (press Enter)‚Ä¶" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--border)" />
    </div>
    <div id="searchInfo" style="margin-bottom:8px;color:#666"></div>
    <div id="searchResults"></div>
  </section>

  <section id="pane-parallel" class="card pane" aria-label="Parallel" style="display:none">
    <div style="font-weight:800;color:#083a5e;margin-bottom:12px">Parallel ‚Äî compare two versions</div>
    <div class="parallel-controls card" style="padding:12px;max-width:960px;margin:0 auto 12px auto">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <label style="min-width:110px;font-weight:700;color:#334">Choose versions</label>
        <select id="parallelA" class="select"><option value="">Version A</option></select>
        <select id="parallelB" class="select"><option value="">Version B</option></select>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px">
        <label style="min-width:110px;font-weight:700;color:#334">Choose passage</label>
        <select id="parallelBook" class="select"><option value="">Book</option></select>
        <select id="parallelChapter" class="select"><option value="">Chapter</option></select>
        <select id="parallelVerse" class="select"><option value="">Verse</option></select>
        <div style="flex:1"></div>
        <button id="parallelOpen" class="btn">OPEN (view in READ)</button>
      </div>
    </div>
    <div id="parallelContainer" class="parallel-container"></div>
  </section>
</main>

<nav id="bottomNav" class="bottom-nav" aria-hidden="false">
  <div class="bottom-item" data-tab="home">üè†<div style="font-size:11px">Home</div></div>
  <div class="bottom-item active" data-tab="read">üìñ<div style="font-size:11px">Read</div></div>
  <div class="bottom-item" data-tab="search">üîé<div style="font-size:11px">Search</div></div>
  <div class="bottom-item" data-tab="parallel">üìö<div style="font-size:11px">Parallel</div></div>
</nav>

<div id="notice" class="notice" role="status" aria-live="polite"></div>

<script>
(async function(){
  const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";
  const FILES = [
"AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json","NIV_bible.json","NKJV_bible.json","NLT_bible.json",
"afrikaans_bible.json","bengali_bible.json","gujarati_bible.json","hindi_bible.json","hungarian_bible.json","indonesian_bible.json",
"kannada_bible.json","malayalam_bible.json","marathi_bible.json","nepali_bible.json","odia_bible.json","punjabi_bible.json",
"sepedi_bible.json","tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
  ];

  const tabs = { home: document.getElementById('tab-home'), read: document.getElementById('tab-read'), search: document.getElementById('tab-search'), parallel: document.getElementById('tab-parallel') };
  const panes = { home: document.getElementById('pane-home'), read: document.getElementById('pane-read'), search: document.getElementById('pane-search'), parallel: document.getElementById('pane-parallel') };
  const homeVersion = document.getElementById('homeVersion'); const homeBook = document.getElementById('homeBook'); const homeChapter = document.getElementById('homeChapter'); const homeVerse = document.getElementById('homeVerse'); const homeRange = document.getElementById('homeRange'); const homeOpen = document.getElementById('homeOpen');
  const readRef = document.getElementById('readRef'); const readVerses = document.getElementById('readVerses'); const readNav = document.getElementById('readNav');
  const prevVerseBtn = document.getElementById('prevVerse'); const nextVerseBtn = document.getElementById('nextVerse'); const prevChapterBtn = document.getElementById('prevChapter'); const nextChapterBtn = document.getElementById('nextChapter');
  const playBtn = document.getElementById('play'); const pauseBtn = document.getElementById('pause'); const resumeBtn = document.getElementById('resume'); const stopBtn = document.getElementById('stop');
  const searchBox = document.getElementById('searchBox'); const searchInfo = document.getElementById('searchInfo'); const searchResults = document.getElementById('searchResults');
  const parallelA = document.getElementById('parallelA'); const parallelB = document.getElementById('parallelB'); const parallelBook = document.getElementById('parallelBook'); const parallelChapter = document.getElementById('parallelChapter'); const parallelVerse = document.getElementById('parallelVerse'); const parallelOpen = document.getElementById('parallelOpen'); const parallelContainer = document.getElementById('parallelContainer');
  const notice = document.getElementById('notice');
  const bottomNav = document.getElementById('bottomNav'); const bottomItems = bottomNav.querySelectorAll('.bottom-item');

  let rawCache = {}, normCache = {}, searchIndexCache = {};
  let state = { version: null, bookIndex: 0, chapterIndex: 0, verseKey: null, view: 'home', parallelB: null };

  function showNotice(msg, ms=1400){ notice.textContent = msg; notice.style.display='block'; setTimeout(()=> notice.style.display='none', ms); }
  function esc(s){ return (s===undefined||s===null)?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function sortKeys(keys){ return keys.sort((a,b)=> (parseInt(String(a).split('-')[0])||0) - (parseInt(String(b).split('-')[0])||0)); }
  function saveSelectedVersions(){ try{ localStorage.setItem('lastPrimary', state.version || ''); localStorage.setItem('lastParallelB', state.parallelB || ''); }catch(e){} }
  function loadSelectedVersions(){ try{ const p = localStorage.getItem('lastPrimary'); const pb = localStorage.getItem('lastParallelB'); if(p) state.version = p; if(pb) state.parallelB = pb; }catch(e){} }

  function normalize(json){
    if(!json) return {books:[]};
    if(json.books && Array.isArray(json.books)){
      return { books: json.books.map(b=>({ name: b.name||b.book||'Unknown', chapters: (b.chapters||[]).map(ch=>{ if(Array.isArray(ch)) return ch.map((t,i)=>({key:String(i+1), text:t})); if(typeof ch==='object'){ const ks=sortKeys(Object.keys(ch||{})); return ks.map(k=>({key:k,text:ch[k]})); } return []; }) })) };
    }
    const books=[];
    for(const bk of Object.keys(json||{})){
      const bookObj = json[bk]; if(!bookObj || typeof bookObj !== 'object') continue;
      const ckeys = Object.keys(bookObj).sort((a,b)=>Number(a)-Number(b)); const chapters=[];
      for(const ck of ckeys){ const ch = bookObj[ck]; if(!ch || typeof ch !== 'object'){ chapters.push([]); continue; } const vks = sortKeys(Object.keys(ch||{})); chapters.push(vks.map(vk=>({key:vk, text: ch[vk]}))); }
      books.push({name: bk, chapters});
    }
    return { books };
  }

  async function fetchAndNormalize(fname){
    if(!fname) throw new Error("No file");
    if(normCache[fname]) return normCache[fname];
    const res = await fetch(BASE + fname);
    if(!res.ok) throw new Error("Fetch failed: " + res.status + " (" + fname + ")");
    const j = await res.json();
    rawCache[fname] = j;
    const n = normalize(j);
    normCache[fname] = n;
    buildSearchIndex(fname, n);
    return n;
  }

  function buildSearchIndex(fname, norm){
    if(searchIndexCache[fname]) return searchIndexCache[fname];
    const arr=[]; (norm.books||[]).forEach((b,bi)=>{ (b.chapters||[]).forEach((ch,ci)=>{ (ch||[]).forEach((v,vi)=>{ const t=(v&&v.text)?v.text:''; arr.push({bookIndex:bi,chapterIndex:ci,verseIndex:vi,book:b.name,chapter:ci+1,verseKey:v.key,text:t,low:t.toLowerCase()}); }); }); });
    searchIndexCache[fname] = arr; return arr;
  }

  FILES.forEach(f=>{ const label = f.replace("_bible.json","").replace(".json","").toUpperCase(); homeVersion.appendChild(new Option(label,f)); parallelA.appendChild(new Option(label,f)); parallelB.appendChild(new Option(label,f)); });

  function activateTab(name){
    state.view = name;
    Object.keys(panes).forEach(k => { panes[k].style.display = (k===name) ? 'block' : 'none'; });
    Object.values(tabs).forEach(t => t.classList.remove('active'));
    if(tabs[name]) tabs[name].classList.add('active');
    bottomItems.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
    if(name === 'parallel') renderParallelPreview();
    if(name === 'read') renderRead();
    if(name !== 'search') { searchBox.value = ''; searchResults.innerHTML=''; searchInfo.textContent=''; }
  }
  Object.keys(tabs).forEach(k => tabs[k].addEventListener('click', ()=> activateTab(k) ));
  bottomItems.forEach(b => b.addEventListener('click', ()=> activateTab(b.dataset.tab)));

  function readUrlIntoState(){
    const p = new URLSearchParams(location.search);
    const v = p.get('version'); if(v) state.version = v;
    state.bookIndex = Number(p.get('bookIndex') || state.bookIndex || 0);
    state.chapterIndex = Number(p.get('chapter') ? Number(p.get('chapter') - 1) : (state.chapterIndex || 0));
    state.verseKey = p.get('verse') || state.verseKey || null;
    const pb = p.get('parallelB'); if(pb) state.parallelB = pb;
    state.view = p.get('view') || state.view || 'home';
  }

  loadSelectedVersions(); readUrlIntoState();

  async function populateHomeBooks(fname){
    if(!fname) return;
    try{ const n = await fetchAndNormalize(fname); homeBook.innerHTML = "<option value=''>Book</option>"; n.books.forEach((b,i)=> homeBook.appendChild(new Option(b.name,i))); homeChapter.innerHTML = "<option value=''>Chapter</option>"; homeVerse.innerHTML = "<option value=''>Verse</option>"; }catch(e){ console.warn(e); showNotice('Failed to load version'); }
  }

  homeBook.addEventListener('change', async function(){ const bi = Number(this.value || 0); if(!state.version) return; const n = await fetchAndNormalize(state.version); const ccount = (n.books[bi] && n.books[bi].chapters) ? n.books[bi].chapters.length : 0; homeChapter.innerHTML = "<option value=''>Chapter</option>"; for(let i=1;i<=ccount;i++) homeChapter.appendChild(new Option(i, i-1)); homeVerse.innerHTML = "<option value=''>Verse</option>"; });
  homeChapter.addEventListener('change', async function(){ const bi = Number(homeBook.value || 0); const ci = Number(this.value || 0); if(!state.version) return; const n = await fetchAndNormalize(state.version); const vcount = (n.books[bi] && n.books[bi].chapters[ci]) ? n.books[bi].chapters[ci].length : 0; homeVerse.innerHTML = "<option value=''>Verse</option>"; for(let v=1; v<=vcount; v++) homeVerse.appendChild(new Option(v, v-1)); });

  homeVersion.addEventListener('change', async function(){ const f = this.value; if(!f) return; state.version = f; parallelA.value = f; await populateHomeBooks(f); showNotice(this.options[this.selectedIndex].text + ' loaded'); saveSelectedVersions(); });

  homeOpen.addEventListener('click', async function(){
    if(!state.version){ showNotice('Select a version'); return; }
    const bi = homeBook.value !== '' ? Number(homeBook.value) : 0;
    const ci = homeChapter.value !== '' ? Number(homeChapter.value) : 0;
    const viDropdown = homeVerse.value !== '' ? Number(homeVerse.value) : null;
    const rng = (homeRange.value || '').trim();
    state.bookIndex = bi; state.chapterIndex = ci;
    if(rng) state.verseKey = rng; else if(viDropdown !== null) state.verseKey = String(viDropdown + 1); else state.verseKey = null;
    try{ await fetchAndNormalize(state.version); }catch(e){ showNotice('Failed to load version'); return; }
    saveSelectedVersions(); activateTab('read'); await renderRead(); updateUrl();
  });

  async function renderRead(){
    if(!state.version){ readRef.textContent = 'No version selected'; readVerses.innerHTML=''; return; }
    try{ await fetchAndNormalize(state.version); }catch(e){ readRef.textContent = 'Failed to load primary version'; readVerses.innerHTML = '<div style="padding:12px;color:#666">Failed to load primary version.</div>'; return; }
    if(state.parallelB){ try{ await fetchAndNormalize(state.parallelB); }catch(e){} }
    const n = normCache[state.version]; if(!n){ readRef.textContent = 'No data'; readVerses.innerHTML=''; return; }
    if(state.bookIndex < 0) state.bookIndex = 0; if(state.bookIndex >= n.books.length) state.bookIndex = 0;
    const book = n.books[state.bookIndex]; if(!book){ readRef.textContent = 'No book'; readVerses.innerHTML=''; return; }
    if(state.chapterIndex < 0) state.chapterIndex = 0; if(state.chapterIndex >= book.chapters.length) state.chapterIndex = 0;
    const chapA = book.chapters[state.chapterIndex] || [];
    readRef.textContent = `${book.name} ${state.chapterIndex + 1}`; readVerses.innerHTML = '';
    if(state.parallelB){
      const pb = state.parallelB; const nb = normCache[pb]; const bookB = nb ? (nb.books[state.bookIndex] || {chapters:[]}) : {chapters:[]}; const chapB = bookB.chapters[state.chapterIndex] || [];
      if(state.verseKey){
        const exact = chapA.findIndex(v=>v.key===state.verseKey);
        if(exact !== -1){ renderCombinedBox(exact, chapA, chapB, state.version, pb); showReadNav(true, exact); return; }
        const m = state.verseKey.match(/^(\d+)\s*-\s*(\d+)$/);
        if(m){ const s = Number(m[1]) -1, e = Number(m[2]) -1, start = Math.max(0, Math.min(s, chapA.length-1)), end = Math.max(start, Math.min(e, chapA.length-1)); for(let i=start;i<=end;i++) renderCombinedBox(i, chapA, chapB, state.version, pb); showReadNav(true, start); return; }
        if(/^\d+$/.test(state.verseKey)){ const idx = Math.max(0, Math.min(Number(state.verseKey)-1, chapA.length-1)); renderCombinedBox(idx, chapA, chapB, state.version, pb); showReadNav(true, idx); return; }
        readVerses.innerHTML = '<div style="padding:12px;color:#666">Verse not found</div>'; showReadNav(false); return;
      }
      const maxLen = Math.max(chapA.length, chapB.length);
      for(let i=0;i<maxLen;i++) renderCombinedBox(i, chapA, chapB, state.version, pb);
      showReadNav(false); return;
    }
    if(state.verseKey){
      const exact = chapA.findIndex(v=>v.key===state.verseKey);
      if(exact !== -1){ renderSingleBox(state.version, exact); showReadNav(true, exact); return; }
      const m = state.verseKey.match(/^(\d+)\s*-\s*(\d+)$/);
      if(m){ const s = Math.max(1, Number(m[1])) -1, e = Math.max(1, Number(m[2])) -1, start=Math.max(0,Math.min(s,chapA.length-1)), end=Math.max(start,Math.min(e,chapA.length-1)); renderRange(state.version, start, end); showReadNav(true, start); return; }
      if(/^\d+$/.test(state.verseKey)){ const idx = Math.max(0, Math.min(Number(state.verseKey)-1, chapA.length-1)); renderSingleBox(state.version, idx); showReadNav(true, idx); return; }
      readVerses.innerHTML = '<div style="padding:12px;color:#666">Verse not found</div>'; showReadNav(false); return;
    }
    for(let i=0;i<chapA.length;i++){ const v = chapA[i]; const block = document.createElement('div'); block.className='verse-block'; block.innerHTML = `<div class="verse-num">Verse ${v.key}</div><div class="verse-text">${esc(v.text)}</div>`; readVerses.appendChild(block); }
    showReadNav(false);
  }

  function renderCombinedBox(idx, chapA, chapB, fileA, fileB){
    const va = chapA[idx] || null; const vb = chapB[idx] || null; const key = va ? va.key : (vb ? vb.key : (idx+1));
    const labelA = (fileA||'').replace('_bible.json','').replace('.json','').toUpperCase();
    const labelB = (fileB||'').replace('_bible.json','').replace('.json','').toUpperCase();
    const block = document.createElement('div'); block.className='verse-block parallel';
    let inner = `<div class="verse-num">Verse ${key}</div>`;
    inner += `<div class="verse-label">${esc(labelA)}</div>`;
    inner += `<div class="verse-text">${esc(va?va.text:'')}</div>`;
    inner += `<div class="verse-label">${esc(labelB)}</div>`;
    inner += `<div class="verse-secondary">${esc(vb?vb.text:'')}</div>`;
    block.innerHTML = inner; readVerses.appendChild(block);
  }

  function renderSingleBox(fname, idx){ const n = normCache[fname]; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]; const v = ch[idx]; readVerses.innerHTML = `<div class="verse-block active-verse"><div class="verse-num">Verse ${v.key}</div><div class="verse-text">${esc(v.text)}</div></div>`; }
  function renderRange(fname, s, e){ const n = normCache[fname]; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]; const comb = ch.slice(s,e+1).map(x=>x.text).join(' '); readVerses.innerHTML = `<div class="verse-block active-verse"><div class="verse-num">Verses ${ch[s].key}${s!==e?('-'+ch[e].key):''}</div><div class="verse-text">${esc(comb)}</div></div>`; }

  let currentVerseIndex = null;
  function showReadNav(show, idx=null){ readNav.style.display = show ? 'flex' : 'none'; currentVerseIndex = (typeof idx==='number')?idx:null; }

  prevVerseBtn && prevVerseBtn.addEventListener('click', ()=>{ if(currentVerseIndex===null) return; const n = normCache[state.version]; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]; if(currentVerseIndex>0){ setVerseKeyByIndex(currentVerseIndex-1); } else { if(state.chapterIndex>0){ state.chapterIndex--; const ch2 = n.books[state.bookIndex].chapters[state.chapterIndex]; setVerseKeyByIndex(ch2.length-1); } } });
  nextVerseBtn && nextVerseBtn.addEventListener('click', ()=>{ if(currentVerseIndex===null) return; const n = normCache[state.version]; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]; if(currentVerseIndex < ch.length-1){ setVerseKeyByIndex(currentVerseIndex+1); } else { if(state.chapterIndex+1 < n.books[state.bookIndex].chapters.length){ state.chapterIndex++; state.verseKey = null; renderRead(); updateUrl(); } } });
  function setVerseKeyByIndex(idx){ const n = normCache[state.version]; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]; state.verseKey = ch[idx].key; renderRead(); updateUrl(); }

  prevChapterBtn && prevChapterBtn.addEventListener('click', ()=>{ if(state.chapterIndex>0){ state.chapterIndex--; state.verseKey=null; renderRead(); updateUrl(); } });
  nextChapterBtn && nextChapterBtn.addEventListener('click', ()=>{ const n = normCache[state.version]; if(state.chapterIndex+1 < n.books[state.bookIndex].chapters.length){ state.chapterIndex++; state.verseKey=null; renderRead(); updateUrl(); } });

  let touchStartX = 0; document.addEventListener('touchstart', e=> touchStartX = e.changedTouches[0].clientX);
  document.addEventListener('touchend', e=>{ const dx = e.changedTouches[0].clientX - touchStartX; if(Math.abs(dx)<60) return; const n = normCache[state.version]; if(dx<0){ if(state.chapterIndex+1 < n.books[state.bookIndex].chapters.length){ state.chapterIndex++; state.verseKey=null; renderRead(); updateUrl(); } } else { if(state.chapterIndex>0){ state.chapterIndex--; state.verseKey=null; renderRead(); updateUrl(); } } });

  let mouseDown=false, startX=0, curX=0;
  readVerses.addEventListener('mousedown', e=>{ mouseDown=true; startX=e.clientX; });
  document.addEventListener('mousemove', e=>{ if(!mouseDown) return; curX=e.clientX; });
  document.addEventListener('mouseup', e=>{ if(!mouseDown) return; mouseDown=false; const dx = (curX||e.clientX)-startX; if(Math.abs(dx)>100){ const n = normCache[state.version]; if(dx<0){ if(state.chapterIndex+1 < n.books[state.bookIndex].chapters.length){ state.chapterIndex++; state.verseKey=null; renderRead(); updateUrl(); } } else { if(state.chapterIndex>0){ state.chapterIndex--; state.verseKey=null; renderRead(); updateUrl(); } } } startX=curX=0; });
  document.addEventListener('keydown', e=>{ if(e.key==='ArrowRight'){ const n = normCache[state.version]; if(n && state.chapterIndex+1 < n.books[state.bookIndex].chapters.length){ state.chapterIndex++; state.verseKey=null; renderRead(); updateUrl(); } } if(e.key==='ArrowLeft'){ if(state.chapterIndex>0){ state.chapterIndex--; state.verseKey=null; renderRead(); updateUrl(); } } });

  let ttsQueue=[];
  function buildTTS(){ ttsQueue=[]; if(!state.version) return; const n = normCache[state.version]; if(!n) return; const ch = n.books[state.bookIndex].chapters[state.chapterIndex]||[]; if(state.verseKey){ const exact = ch.findIndex(v=>v.key===state.verseKey); if(exact!==-1){ ttsQueue.push({text:ch[exact].text, idx:exact}); return; } const m = state.verseKey.match(/^(\d+)\s*-\s*(\d+)$/); if(m){ const s=Number(m[1])-1,e=Number(m[2])-1; for(let i=Math.max(0,s);i<=Math.min(e,ch.length-1);i++) ttsQueue.push({text:ch[i].text, idx:i}); return; } if(/^\d+$/.test(state.verseKey)){ const idx=Math.max(0,Math.min(Number(state.verseKey)-1,ch.length-1)); ttsQueue.push({text:ch[idx].text, idx}); return; } return; } for(let i=0;i<ch.length;i++) ttsQueue.push({text:ch[i].text, idx:i}); }
  function speakNext(){ if(ttsQueue.length===0) return; const item = ttsQueue.shift(); if(!item||!item.text) return setTimeout(speakNext,120); const blocks = document.querySelectorAll('.verse-block'); blocks.forEach(b=>b.classList.remove('active-verse')); if(blocks[item.idx]){ blocks[item.idx].classList.add('active-verse'); blocks[item.idx].scrollIntoView({behavior:'smooth', block:'center'}); } const u = new SpeechSynthesisUtterance(String(item.text)); u.onend = ()=> setTimeout(speakNext,120); u.onerror = ()=> setTimeout(speakNext,180); speechSynthesis.speak(u); }
  playBtn.addEventListener('click', ()=>{ speechSynthesis.cancel(); buildTTS(); speakNext(); });
  pauseBtn.addEventListener('click', ()=>{ try{ speechSynthesis.pause(); }catch(e){} });
  resumeBtn.addEventListener('click', ()=>{ try{ speechSynthesis.resume(); }catch(e){} });
  stopBtn.addEventListener('click', ()=>{ try{ speechSynthesis.cancel(); ttsQueue=[]; }catch(e){} });

  async function doSearch(q){
    searchResults.innerHTML=''; searchInfo.textContent='';
    if(!q) return;
    if(!state.version){ searchInfo.textContent='Select a version in HOME first'; return; }
    try{ await fetchAndNormalize(state.version); const idx = searchIndexCache[state.version] || buildSearchIndex(state.version, normCache[state.version]); const results=[]; const max=250; for(let i=0;i<idx.length && results.length<max;i++){ if(idx[i].low.includes(q)) results.push(idx[i]); } searchInfo.textContent = `Found ${results.length}`; if(!results.length){ searchResults.innerHTML='<div style="padding:8px;color:#666">No results</div>'; return; } const safe = q.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&'); const re = new RegExp(safe,'ig'); const frag = document.createDocumentFragment(); results.forEach(r=>{ const div=document.createElement('div'); div.className='search-item'; const snippet = esc(r.text).replace(re, m=>`<span class="highlight">${m}</span>`); div.innerHTML = `<strong>${esc(r.book)} ${r.chapter}:${r.verseKey}</strong><div style="margin-top:6px">${snippet}</div><small style="display:block;margin-top:6px;color:#666">Click to open</small>`; div.onclick = async ()=>{ state.bookIndex = r.bookIndex; state.chapterIndex = r.chapterIndex; state.verseKey = r.verseKey; activateTab('read'); await fetchAndNormalize(state.version); renderRead(); updateUrl(); }; frag.appendChild(div); }); searchResults.appendChild(frag); activateTab('search'); }catch(e){ showNotice('Search failed'); } }
  searchBox.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch((searchBox.value||'').trim().toLowerCase()); });

  parallelA.addEventListener('change', async function(){ const f = this.value || state.version; if(!f) return; state.version = f; parallelA.value = f; await populateHomeBooks(f); parallelBook.innerHTML = "<option value=''>Book</option>"; const n = normCache[f]; n.books.forEach((b,i)=> parallelBook.appendChild(new Option(b.name,i))); parallelChapter.innerHTML = "<option value=''>Chapter</option>"; parallelVerse.innerHTML = "<option value=''>Verse</option>"; showNotice(this.options[this.selectedIndex].text + ' loaded (A)'); saveSelectedVersions(); });

  parallelBook.addEventListener('change', async function(){ const bi = Number(this.value || 0); const f = parallelA.value || state.version; if(!f) return; const n = await fetchAndNormalize(f); const ccount = (n.books[bi] && n.books[bi].chapters) ? n.books[bi].chapters.length : 0; parallelChapter.innerHTML = "<option value=''>Chapter</option>"; for(let i=1;i<=ccount;i++) parallelChapter.appendChild(new Option(i, i-1)); parallelVerse.innerHTML = "<option value=''>Verse</option>"; });

  parallelChapter.addEventListener('change', async function(){ const bi = Number(parallelBook.value || 0); const ci = Number(this.value || 0); const f = parallelA.value || state.version; if(!f) return; const n = await fetchAndNormalize(f); const vcount = (n.books[bi] && n.books[bi].chapters[ci]) ? n.books[bi].chapters[ci].length : 0; parallelVerse.innerHTML = "<option value=''>Verse</option>"; for(let v=1; v<=vcount; v++) parallelVerse.appendChild(new Option(v, v-1)); });

  parallelOpen.addEventListener('click', async function(){ const a = parallelA.value || state.version; const b = parallelB.value || state.parallelB; if(!a || !b){ showNotice('Select both versions'); return; } const bi = parallelBook.value !== '' ? Number(parallelBook.value) : 0; const ci = parallelChapter.value !== '' ? Number(parallelChapter.value) : 0; const vi = parallelVerse.value !== '' ? Number(parallelVerse.value) : null; state.version = a; state.parallelB = b; state.bookIndex = bi; state.chapterIndex = ci; state.verseKey = (vi !== null) ? String(vi + 1) : null; try{ await fetchAndNormalize(a); await fetchAndNormalize(b); }catch(e){ showNotice('Failed to load versions'); return; } saveSelectedVersions(); activateTab('read'); await renderRead(); updateUrl(); });

  function renderParallelPreview(){ parallelContainer.innerHTML = '<div style="padding:12px;color:#666">Choose two versions and a passage. Click OPEN to view combined passage in READ.</div>'; }
  function updateUrl(replace=false){ const p = new URLSearchParams(); if(state.version) p.set('version', state.version); p.set('bookIndex', String(state.bookIndex)); p.set('chapter', String(state.chapterIndex + 1)); if(state.verseKey) p.set('verse', state.verseKey); if(state.parallelB) p.set('parallelB', state.parallelB); p.set('view', state.view || 'home'); const url = location.pathname + '?' + p.toString(); if(replace) history.replaceState({...state}, '', url); else history.pushState({...state}, '', url); }

  let lastScroll = window.scrollY || 0; let navHidden = false;
  function handleScrollHide(){ const y = window.scrollY || 0; const delta = y - lastScroll; lastScroll = y; if(y < 60){ showBottomNav(); return; } if(delta > 12 && !navHidden){ hideBottomNav(); } else if(delta < -12 && navHidden){ showBottomNav(); } }
  function hideBottomNav(){ bottomNav.classList.add('hidden'); navHidden = true; }
  function showBottomNav(){ bottomNav.classList.remove('hidden'); navHidden = false; }
  bottomNav.addEventListener('touchstart', e=> e.stopPropagation(), {passive:true}); window.addEventListener('scroll', handleScrollHide, {passive:true});

  async function initialLoad(){ if(state.version){ homeVersion.value = state.version; parallelA.value = state.version; try{ await fetchAndNormalize(state.version); await populateHomeBooks(state.version); }catch(e){} } if(state.parallelB){ parallelB.value = state.parallelB; } activateTab(state.view || 'home'); if(state.view==='read'){ await renderRead(); } if(state.view==='parallel'){ renderParallelPreview(); } }
  await initialLoad();
  window.addEventListener('popstate', async e=>{ readUrlIntoState(); if(state.version){ await fetchAndNormalize(state.version); await populateHomeBooks(state.version); } activateTab(state.view || 'home'); if(state.view==='read') await renderRead(); if(state.view==='parallel') renderParallelPreview(); });

})(); // end IIFE
</script>
</body>
</html>

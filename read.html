<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#f7f9fc;
  --accent:#0b66c2;
  --border:#e2e8f0;
}
body {
  background: var(--bg);
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
}
.header {
  background: white;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 16px;
  font-weight: 600;
  color: var(--accent);
  display: flex;
  gap: 16px;
  align-items: center;
}
.header a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 700;
}
.container {
  max-width: 900px;
  margin: 20px auto;
  padding: 0 16px;
}
.ref {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 16px;
}
.verse {
  background: #fff;
  border: 1px solid var(--border);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
}
.verse-num {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 6px;
}
.verse-text {
  font-family: "Noto Serif", serif;
  font-size: 18px;
  line-height: 1.7;
}
.active-verse {
  background: #fff8d1 !important;
  border-color: #ffd56b !important;
}
.note {
  font-size: 12px;
  color: #777;
  margin-left: auto;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <a href="/">‚Üê Back</a>
  <div class="note">Swipe left/right to change chapter</div>
</div>

<!-- CONTENT -->
<div class="container">
  <div id="ref" class="ref"></div>
  <div id="verses"></div>
</div>

<script>
(async function(){

  const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";

  function esc(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function sortVerseKeys(keys){
    return keys.sort((a,b)=>{
      const pa = parseInt(a.split("-")[0]) || 0;
      const pb = parseInt(b.split("-")[0]) || 0;
      return pa - pb;
    });
  }

  // Normalize JSON to common shape
  function normalize(json) {
    const books = [];

    for (const bookName of Object.keys(json)) {
      const chapters = [];
      const chapterKeys = Object.keys(json[bookName]).sort((a,b)=>Number(a)-Number(b));

      for (const ck of chapterKeys) {
        const chObj = json[bookName][ck];
        const verses = [];
        const vkeys = sortVerseKeys(Object.keys(chObj));

        vkeys.forEach(k=>{
          verses.push({ key:k, text:chObj[k] });
        });

        chapters.push(verses);
      }

      books.push({ name: bookName, chapters });
    }

    return books;
  }

  // Read URL Parameters
  const params = new URLSearchParams(location.search);
  const version = params.get("version");
  const bookIndex = Number(params.get("bookIndex") || 0);
  const chapterNum = Number(params.get("chapter") || 1);
  const verseParam = params.get("verse"); // e.g., "7-8" or "3"

  const chapterIndex = chapterNum - 1;

  // Load Bible JSON
  const res = await fetch(BASE + version + ".json");
  const json = await res.json();
  const bible = normalize(json);

  const book = bible[bookIndex];
  const chapter = book.chapters[chapterIndex];

  const refEl = document.getElementById("ref");
  const versesEl = document.getElementById("verses");

  // Set reference title
  refEl.textContent = `${book.name} ${chapterNum}`;

  // Render chapter
  function render() {
    versesEl.innerHTML = "";

    let highlightKey = verseParam;

    // If numeric 7 convert to key "7"
    if (highlightKey && /^\d+$/.test(highlightKey)) {
      const match = chapter.find(v => v.key === highlightKey);
      if (!match) {
        // fallback: find by index
        const idx = Number(highlightKey)-1;
        if (chapter[idx]) highlightKey = chapter[idx].key;
      }
    }

    chapter.forEach(v => {
      const div = document.createElement("div");
      div.className = "verse";
      if (v.key === highlightKey) div.classList.add("active-verse");

      div.innerHTML = `
        <div class="verse-num">Verse ${v.key}</div>
        <div class="verse-text">${esc(v.text)}</div>
      `;

      versesEl.appendChild(div);
    });
  }

  render();

  // Swipe navigation
  let startX = 0;

  document.addEventListener("touchstart", e=>{
    startX = e.changedTouches[0].clientX;
  });

  document.addEventListener("touchend", e=>{
    const endX = e.changedTouches[0].clientX;
    const delta = endX - startX;

    if (Math.abs(delta) < 60) return;

    if (delta < 0) nextChapter();
    else prevChapter();
  });

  document.addEventListener("keydown", e=>{
    if (e.key === "ArrowRight") nextChapter();
    if (e.key === "ArrowLeft") prevChapter();
  });

  function nextChapter(){
    if (chapterIndex + 1 >= book.chapters.length) return;
    goToChapter(chapterIndex + 1);
  }

  function prevChapter(){
    if (chapterIndex - 1 < 0) return;
    goToChapter(chapterIndex - 1);
  }

  function goToChapter(chIndex){
    const p = new URLSearchParams();
    p.set("version", version);
    p.set("bookIndex", bookIndex);
    p.set("chapter", chIndex + 1);
    location.search = p.toString();
  }

})();
</script>

</body>
</html>

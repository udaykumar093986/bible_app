<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read — Bible Reader</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
:root { --bg:#f7f9fc; --accent:#0b66c2; --border:#e2e8f0; }
body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); }

.header {
  background:#fff; padding:12px 16px; border-bottom:1px solid var(--border);
  display:flex; gap:14px; align-items:center;
}
.header a { color:var(--accent); font-weight:700; text-decoration:none; }

.container { max-width:900px; margin:20px auto; padding:0 16px; }

.controls {
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px; align-items:center;
}
select {
  padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:white;
}
button {
  padding:8px 12px; border-radius:8px; border:0; background:var(--accent);
  color:white; cursor:pointer; font-weight:600;
}

.ref {
  font-size:22px; font-weight:700; color:var(--accent); margin-bottom:16px;
}

.verse-block {
  background:#fff; padding:14px; border-radius:12px;
  border:1px solid var(--border); margin-bottom:12px;
}
.verse-num { font-weight:700; margin-bottom:6px; }
.verse-primary {
  font-family:"Noto Serif",serif; font-size:18px; line-height:1.7;
}
.verse-parallel {
  margin-top:10px; padding-left:14px;
  border-left:3px solid var(--accent);
  font-size:17px; line-height:1.6;
  font-family:"Noto Serif",serif;
  color:#2a3c55;
}

.active-verse {
  background:#fff8d1 !important;
  border-color:#ffd56b !important;
}

.note { font-size:13px; color:#666; margin-left:auto; }
</style>
</head>

<body>

<div class="header">
  <a href="/">← Back</a>
  <div class="note">Swipe left/right to change chapter</div>
</div>

<div class="container">

  <!-- CONTROLS -->
  <div class="controls">
    <select id="primarySel"></select>
    <select id="parallelSel"></select>

    <button id="playBtn">▶ Play</button>
    <button id="pauseBtn">⏸ Pause</button>
    <button id="resumeBtn">⏯ Resume</button>
    <button id="stopBtn">⏹ Stop</button>
  </div>

  <!-- REFERENCE -->
  <div id="ref" class="ref"></div>

  <!-- VERSES AREA -->
  <div id="verses"></div>

</div>

<script>
(async function(){

  const BASE =
    "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";

  // FULL LIST OF YOUR FILES
  const FILES = [
    "AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json",
    "NIV_bible.json","NKJV_bible.json","NLT_bible.json","afrikaans_bible.json",
    "bengali_bible.json","gujarati_bible.json","hindi_bible.json",
    "hungarian_bible.json","indonesian_bible.json","kannada_bible.json",
    "malayalam_bible.json","marathi_bible.json","nepali_bible.json",
    "odia_bible.json","punjabi_bible.json","sepedi_bible.json",
    "tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
  ];

  // ELEMENTS
  const primarySel = document.getElementById("primarySel");
  const parallelSel = document.getElementById("parallelSel");
  const refEl = document.getElementById("ref");
  const versesEl = document.getElementById("verses");

  const playBtn = document.getElementById("playBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const stopBtn = document.getElementById("stopBtn");

  // Populate selectors with filenames (correct)
  FILES.forEach(f=>{
    primarySel.appendChild(new Option(f, f));
    parallelSel.appendChild(new Option(f, f));
  });

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function sortVerseKeys(keys){
    return keys.sort((a,b)=>{
      const A = parseInt(String(a).split("-")[0]);  
      const B = parseInt(String(b).split("-")[0]);
      return A - B;
    });
  }

  function normalize(json){
    const books = [];
    for(const bk of Object.keys(json)){
      const chObj = json[bk];
      const chapterKeys = Object.keys(chObj).sort((a,b)=>Number(a)-Number(b));
      const chapters = chapterKeys.map(ck=>{
        const vObj = chObj[ck];
        const vkeys = sortVerseKeys(Object.keys(vObj));
        return vkeys.map(k=>({ key:k, text: vObj[k] }));
      });
      books.push({ name: bk, chapters });
    }
    return books;
  }

  // URL PARAMS
  const params = new URLSearchParams(location.search);
  let version = params.get("version") || "telugu_bible.json";
  if(!version.endsWith(".json")) version += ".json";
  let bookIndex = Number(params.get("bookIndex")||0);
  let chapter = Number(params.get("chapter")||1) - 1;
  let verseParam = params.get("verse") || null;

  // Set initial dropdown
  primarySel.value = version;
  parallelSel.value = "AMP_bible.json";

  const cache = {};
  async function loadFile(f){
    if(cache[f]) return cache[f];
    const res = await fetch(BASE + f);
    const j = await res.json();
    const norm = normalize(j);
    cache[f] = norm;
    return norm;
  }

  let primaryBible = await loadFile(primarySel.value);
  let parallelBible = await loadFile(parallelSel.value);

  function render(){
    const book = primaryBible[bookIndex];
    const chapterData = book.chapters[chapter];

    refEl.textContent = `${book.name} ${chapter+1}`;
    versesEl.innerHTML = "";

    let highlightKey = verseParam;

    if(highlightKey && /^\d+$/.test(highlightKey)){
      const idx = Number(highlightKey)-1;
      if(chapterData[idx]) highlightKey = chapterData[idx].key;
    }

    chapterData.forEach((v,i)=>{
      const pb = parallelBible[bookIndex];
      const parallelChapter = pb ? pb.chapters[chapter] : [];
      const parObj = parallelChapter.find(x=>x.key===v.key) || {};

      const div = document.createElement("div");
      div.className = "verse-block" + (v.key===highlightKey ? " active-verse":"");
      div.innerHTML = `
        <div class="verse-num">Verse ${v.key}</div>
        <div class="verse-primary">${esc(v.text)}</div>
        ${ parObj.text ? `<div class="verse-parallel">${esc(parObj.text)}</div>` : "" }
      `;
      versesEl.appendChild(div);
    });

    // Combined range (7-8) case
    if(verseParam && verseParam.includes("-")){
      const [s,e] = verseParam.split("-").map(x=>Number(x)-1);
      const start = Math.max(0, s);
      const end = Math.min(chapterData.length-1, e);
      if(start <= end){
        const combined = chapterData.slice(start,end+1).map(x=>x.text).join(" ");
        const parBook = parallelBible[bookIndex];
        const parCh = parBook ? parBook.chapters[chapter] : [];
        const combinedPar = parCh.slice(start,end+1).map(x=>x.text).join(" ");

        const block = document.createElement("div");
        block.className = "verse-block active-verse";
        block.innerHTML = `
          <div class="verse-num">Verse ${chapterData[start].key}-${chapterData[end].key}</div>
          <div class="verse-primary">${esc(combined)}</div>
          ${ combinedPar ? `<div class="verse-parallel">${esc(combinedPar)}</div>` : "" }
        `;
        versesEl.insertBefore(block, versesEl.firstChild);
      }
    }
  }

  // Dropdown changes
  primarySel.onchange = async ()=>{
    primaryBible = await loadFile(primarySel.value);
    render();
    updateURL();
  };
  parallelSel.onchange = async ()=>{
    parallelBible = await loadFile(parallelSel.value);
    render();
  };

  function updateURL(){
    const p = new URLSearchParams();
    p.set("version", primarySel.value);
    p.set("bookIndex", bookIndex);
    p.set("chapter", chapter+1);
    if(verseParam) p.set("verse",verseParam);
    history.replaceState(null,"",location.pathname+"?"+p.toString());
  }

  // Swipe navigation
  let sx = 0;
  document.addEventListener("touchstart", e=> sx=e.changedTouches[0].clientX);
  document.addEventListener("touchend", e=>{
    const dx = e.changedTouches[0].clientX - sx;
    if(Math.abs(dx) < 60) return;
    if(dx<0) nextChapter();
    else prevChapter();
  });

  document.addEventListener("keydown", e=>{
    if(e.key==="ArrowRight") nextChapter();
    if(e.key==="ArrowLeft") prevChapter();
  });

  function nextChapter(){
    if(chapter+1 < primaryBible[bookIndex].chapters.length){
      chapter++; verseParam=null; render(); updateURL();
    }
  }
  function prevChapter(){
    if(chapter-1 >= 0){
      chapter--; verseParam=null; render(); updateURL();
    }
  }

  // TTS
  let queue = [];
  function buildQueue(){
    queue = [];
    const book = primaryBible[bookIndex];
    const ch = book.chapters[chapter];
    const pbook = parallelBible[bookIndex];
    const pch = pbook ? pbook.chapters[chapter] : [];

    if(verseParam){
      const exact = ch.findIndex(v=>v.key===verseParam);
      if(exact!==-1){
        queue.push({text:ch[exact].text, index:exact});
        if(pch[exact]) queue.push({text:pch[exact].text, index:exact});
        return;
      }
    }

    ch.forEach((v,i)=>{
      queue.push({text:v.text,index:i});
      if(pch[i]) queue.push({text:pch[i].text,index:i});
    });
  }

  function speakNext(){
    if(queue.length===0) return;
    const item = queue.shift();
    highlight(item.index);
    const u = new SpeechSynthesisUtterance(item.text);
    u.rate = 1.0;
    u.onend = ()=>setTimeout(speakNext,120);
    u.onerror = ()=>setTimeout(speakNext,150);
    speechSynthesis.speak(u);
  }

  function highlight(i){
    document.querySelectorAll(".verse-block").forEach(el=>el.classList.remove("active-verse"));
    const blocks = document.querySelectorAll(".verse-block");
    if(blocks[i]){
      blocks[i].classList.add("active-verse");
      blocks[i].scrollIntoView({behavior:"smooth",block:"center"});
    }
  }

  playBtn.onclick = ()=>{
    speechSynthesis.cancel();
    buildQueue();
    speakNext();
  };
  pauseBtn.onclick = ()=>speechSynthesis.pause();
  resumeBtn.onclick = ()=>speechSynthesis.resume();
  stopBtn.onclick = ()=>{
    speechSynthesis.cancel();
    queue=[];
  };

  // INITIAL RENDER
  primaryBible = await loadFile(primarySel.value);
  parallelBible = await loadFile(parallelSel.value);
  render();

})();
</script>
</body>
</html>

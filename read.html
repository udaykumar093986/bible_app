<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader — Read</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f7f9fc; --accent:#0b66c2; --border:#e2e8f0;
  --highlight:#fff8d1;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui}
body{background:var(--bg);color:#1d2d35;-webkit-font-smoothing:antialiased}

/* HEADER */
.header{
  background:#fff;padding:14px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;
}
.header a{
  color:var(--accent);font-weight:700;text-decoration:none;font-size:16px;
}

/* MAIN */
.container{
  max-width:900px;margin:18px auto;padding:0 16px;
}

.controls{
  display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:14px;
}

select{
  padding:10px;border-radius:8px;border:1px solid var(--border);
  background:#fff;font-size:14px;
}
.btn{
  padding:10px 12px;border-radius:8px;border:0;background:var(--accent);
  color:#fff;font-weight:600;cursor:pointer;
}
.small-btn{
  padding:6px 10px;font-size:14px;border-radius:8px;border:0;
  background:var(--accent);color:#fff;cursor:pointer;
}

.ref{
  font-size:22px;font-weight:700;color:var(--accent);
  margin-bottom:14px;
}

/* VERSES */
.verse-block{
  background:#fff;padding:14px;border-radius:12px;
  border:1px solid var(--border);margin-bottom:12px;
}
.verse-num{
  font-size:13px;font-weight:700;color:#345;margin-bottom:6px;
}
.verse-primary{
  font-family:"Noto Serif",serif;font-size:18px;line-height:1.7;color:#111;
}
.verse-parallel{
  margin-top:10px;padding-left:14px;border-left:3px solid var(--accent);
  font-family:"Noto Serif",serif;font-size:17px;color:#2d3c55;
}

.active-verse{
  background:var(--highlight);border-color:#dccb6e;
}

.nav-row{
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;
}

@media(max-width:600px){
  .controls{flex-direction:column}
}
</style>
</head>

<body>

<div class="header">
  <a href="index.html">← Back</a>
  <div style="flex:1"></div>
  <div style="color:#666;font-size:14px;">Swipe / Drag / Arrow Keys</div>
</div>

<div class="container">

  <!-- CONTROLS -->
  <div class="controls">
    <select id="primarySel"></select>
    <select id="parallelSel"></select>

    <button id="playBtn"   class="btn">▶ Play</button>
    <button id="pauseBtn"  class="btn">⏸ Pause</button>
    <button id="resumeBtn" class="btn">⏯ Resume</button>
    <button id="stopBtn"   class="btn">⏹ Stop</button>
  </div>

  <!-- NAVIGATION -->
  <div class="nav-row" id="verseNav" style="display:none">
    <button class="small-btn" id="prevVerse">◀ Prev Verse</button>
    <button class="small-btn" id="nextVerse">Next Verse ▶</button>
    <button class="small-btn" id="prevChapter">◀ Prev Chapter</button>
    <button class="small-btn" id="nextChapter">Next Chapter ▶</button>
  </div>

  <!-- REFERENCE -->
  <div id="ref" class="ref"></div>

  <!-- VERSES -->
  <div id="verses"></div>

</div>

<script>
(async function(){

/* BASE PATH */
const BASE = "https://cdn.jsdelivr.net/gh/udaykumar093986/bibles@main/";

/* ALL VERSIONS (SAME AS index.html) */
const FILES = [
"AMP_bible.json","CSB_bible.json","ESV_bible.json","KJV_bible.json",
"NIV_bible.json","NKJV_bible.json","NLT_bible.json","afrikaans_bible.json",
"bengali_bible.json","gujarati_bible.json","hindi_bible.json",
"hungarian_bible.json","indonesian_bible.json","kannada_bible.json",
"malayalam_bible.json","marathi_bible.json","nepali_bible.json",
"odia_bible.json","punjabi_bible.json","sepedi_bible.json",
"tamil_bible.json","telugu_bible.json","xhosa_bible.json","zulu_bible.json"
];

/* DOM */
const primarySel  = document.getElementById("primarySel");
const parallelSel = document.getElementById("parallelSel");
const refEl       = document.getElementById("ref");
const versesEl    = document.getElementById("verses");

const prevVerseBtn  = document.getElementById("prevVerse");
const nextVerseBtn  = document.getElementById("nextVerse");
const prevChapBtn   = document.getElementById("prevChapter");
const nextChapBtn   = document.getElementById("nextChapter");
const verseNav      = document.getElementById("verseNav");

const playBtn   = document.getElementById("playBtn");
const pauseBtn  = document.getElementById("pauseBtn");
const resumeBtn = document.getElementById("resumeBtn");
const stopBtn   = document.getElementById("stopBtn");

/* Fill dropdowns (uppercase display) */
FILES.forEach(f=>{
  const label=f.replace("_bible.json","").toUpperCase();
  primarySel.appendChild(new Option(label,f));
  parallelSel.appendChild(new Option(label,f));
});

/* URL PARAMS */
const params = new URLSearchParams(location.search);
let versionFile = params.get("version") || "telugu_bible.json";
let bookIndex   = Number(params.get("bookIndex") || 0);
let chapterIndex= Number(params.get("chapter") || 1) - 1;
let verseParam  = params.get("verse") || null;

/* Normalize filename */
if(!versionFile.endsWith(".json")) versionFile += ".json";

primarySel.value = versionFile;
parallelSel.value = FILES.includes(versionFile) ? FILES[0] : FILES[0];

/* FETCH + NORMALIZE */
const cache = {};
function sortKeys(keys){
  return keys.sort((a,b)=>{
    const A=parseInt(String(a).split('-')[0])||0;
    const B=parseInt(String(b).split('-')[0])||0;
    return A-B;
  });
}
function normalize(j){
  if(j.books){
    return j.books.map(b=>({
      name:b.name,
      chapters:b.chapters.map(ch=>{
        if(Array.isArray(ch)) return ch.map((t,i)=>({key:String(i+1),text:t}));
        const vk=sortKeys(Object.keys(ch));
        return vk.map(k=>({key:k,text:ch[k]}));
      })
    }));
  }
  const books=[];
  for(const bn of Object.keys(j)){
    const bookObj=j[bn];
    const chKeys=Object.keys(bookObj).sort((a,b)=>Number(a)-Number(b));
    books.push({
      name:bn,
      chapters:chKeys.map(ck=>{
        const ch=bookObj[ck];
        const vk=sortKeys(Object.keys(ch));
        return vk.map(v=>({key:v,text:ch[v]}));
      })
    });
  }
  return books;
}
async function loadFile(fn){
  if(!cache[fn]){
    const r=await fetch(BASE + fn);
    const j=await r.json();
    cache[fn]=normalize(j);
  }
  return cache[fn];
}

/* LOAD PRIMARY + PARALLEL */
let primaryBible  = await loadFile(primarySel.value);
let parallelBible = await loadFile(parallelSel.value);

/* HELPERS */
function getBook(){ return primaryBible[bookIndex]; }
function getChapter(){ return getBook().chapters[chapterIndex]; }

/* RENDERING */
function render(){
  const book = getBook();
  if(!book){ versesEl.innerHTML="No data"; return; }

  refEl.textContent = `${book.name} ${chapterIndex+1}`;
  const chapter = getChapter();
  versesEl.innerHTML = "";

  /* SINGLE VERSE / RANGE MODE */
  if(verseParam){

    /* EXACT KEY MATCH (supports "7-8") */
    const exactIndex = chapter.findIndex(v=>v.key===verseParam);
    if(exactIndex !== -1){
      renderSingleVerse(exactIndex);
      return;
    }

    /* RANGE 7-9 */
    const m=verseParam.match(/^(\d+)\s*-\s*(\d+)$/);
    if(m){
      const s = Number(m[1]) - 1;
      const e = Number(m[2]) - 1;
      renderRange(s,e);
      return;
    }

    /* NUMERIC SINGLE */
    if(/^\d+$/.test(verseParam)){
      const idx = Number(verseParam)-1;
      if(idx>=0 && idx<chapter.length){
        renderSingleVerse(idx);
        return;
      }
    }

    versesEl.innerHTML = `<div>No such verse</div>`;
    return;
  }

  /* FULL CHAPTER */
  renderFullChapter();
}

/* RENDER HELPERS */
function renderSingleVerse(i){
  const ch = getChapter();
  const v  = ch[i];

  versesEl.innerHTML = "";

  const par = findParallel(v.key);

  const block=document.createElement("div");
  block.className="verse-block active-verse";
  block.innerHTML = `
    <div class="verse-num">Verse ${v.key}</div>
    <div class="verse-primary">${v.text}</div>
    ${par? `<div class="verse-parallel">${par}</div>`:""}
  `;
  versesEl.appendChild(block);

  showVerseNav(true,i);
}

function renderRange(start,end){
  const ch = getChapter();
  const s=Math.max(0,start);
  const e=Math.min(ch.length-1,end);

  const combined = ch.slice(s,e+1).map(x=>x.text).join(" ");
  const parCh = parallelBible[bookIndex].chapters[chapterIndex];
  const combinedPar = parCh.slice(s,e+1).map(x=>x.text).join(" ");

  versesEl.innerHTML = `
    <div class="verse-block active-verse">
      <div class="verse-num">Verses ${ch[s].key}-${ch[e].key}</div>
      <div class="verse-primary">${combined}</div>
      ${combinedPar? `<div class="verse-parallel">${combinedPar}</div>`:""}
    </div>
  `;

  showVerseNav(true,s);
}

function renderFullChapter(){
  const ch = getChapter();
  versesEl.innerHTML = "";

  ch.forEach(v=>{
    const block=document.createElement("div");
    block.className="verse-block";
    const par=findParallel(v.key);
    block.innerHTML=`
      <div class="verse-num">Verse ${v.key}</div>
      <div class="verse-primary">${v.text}</div>
      ${par? `<div class="verse-parallel">${par}</div>`:""}
    `;
    versesEl.appendChild(block);
  });

  showVerseNav(false,null);
}

function findParallel(key){
  const parCh=parallelBible[bookIndex].chapters[chapterIndex];
  const v=parCh.find(x=>x.key===key);
  return v? v.text : null;
}

/* VERSE NAV */
let currentVerseIndex=null;

function showVerseNav(show,idx){
  verseNav.style.display = show? "flex":"none";
  currentVerseIndex = idx;
}

/* NAV FUNCTIONS */
function goPrevVerse(){
  if(currentVerseIndex==null) return;
  if(currentVerseIndex>0){
    verseParam = getChapter()[currentVerseIndex-1].key;
    render(); updateUrl();
  } else goPrevChapter();
}
function goNextVerse(){
  if(currentVerseIndex==null) return;
  const ch=getChapter();
  if(currentVerseIndex < ch.length-1){
    verseParam = ch[currentVerseIndex+1].key;
    render(); updateUrl();
  } else goNextChapter();
}
function goPrevChapter(){
  if(chapterIndex>0){
    chapterIndex--; verseParam=null;
    render(); updateUrl();
  }
}
function goNextChapter(){
  if(chapterIndex < getBook().chapters.length-1){
    chapterIndex++; verseParam=null;
    render(); updateUrl();
  }
}

/* BUTTON HOOKS */
prevVerseBtn.onclick = goPrevVerse;
nextVerseBtn.onclick = goNextVerse;
prevChapBtn.onclick  = goPrevChapter;
nextChapBtn.onclick  = goNextChapter;

/* DESKTOP SWIPE (DRAG) */
let dragStart=0;
versesEl.addEventListener("mousedown",e=> dragStart=e.clientX);
versesEl.addEventListener("mouseup",e=>{
  const dx=e.clientX-dragStart;
  if(Math.abs(dx)>80) (dx<0? goNextChapter():goPrevChapter());
});

/* MOBILE SWIPE */
let touchStart=0;
document.addEventListener("touchstart",e=> touchStart=e.changedTouches[0].clientX);
document.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-touchStart;
  if(Math.abs(dx)>60) (dx<0? goNextChapter():goPrevChapter());
});

/* ARROW KEYS */
document.addEventListener("keydown",e=>{
  if(e.key==="ArrowRight") goNextChapter();
  if(e.key==="ArrowLeft")  goPrevChapter();
});

/* TTS */
let ttsQueue=[];
function buildQueue(){
  ttsQueue=[];
  const ch=getChapter();
  const parCh=parallelBible[bookIndex].chapters[chapterIndex];

  if(verseParam){
    const idx=ch.findIndex(v=>v.key===verseParam);
    if(idx!==-1){
      ttsQueue.push({text:ch[idx].text, idx});
      if(parCh[idx]) ttsQueue.push({text:parCh[idx].text, idx});
      return;
    }
  }

  ch.forEach((v,i)=>{
    ttsQueue.push({text:v.text, idx:i});
    if(parCh[i]) ttsQueue.push({text:parCh[i].text, idx:i});
  });
}

function speakNext(){
  if(ttsQueue.length===0) return;

  const item=ttsQueue.shift();
  const blocks=document.querySelectorAll(".verse-block");
  blocks.forEach(b=>b.classList.remove("active-verse"));
  if(blocks[item.idx]) blocks[item.idx].classList.add("active-verse");

  blocks[item.idx]?.scrollIntoView({behavior:"smooth",block:"center"});

  const u=new SpeechSynthesisUtterance(item.text);
  u.onend=()=> speakNext();
  speechSynthesis.speak(u);
}

playBtn.onclick=()=>{ speechSynthesis.cancel(); buildQueue(); speakNext(); };
pauseBtn.onclick=()=> speechSynthesis.pause();
resumeBtn.onclick=()=> speechSynthesis.resume();
stopBtn.onclick=()=>{ speechSynthesis.cancel(); ttsQueue=[]; };

/* UPDATE URL */
function updateUrl(){
  const p=new URLSearchParams();
  p.set("version", primarySel.value);
  p.set("bookIndex", bookIndex);
  p.set("chapter", chapterIndex+1);
  if(verseParam) p.set("verse", verseParam);
  history.replaceState(null,"","?"+p.toString());
}

/* VERSION SWITCHING */
primarySel.onchange = async function(){
  primaryBible = await loadFile(primarySel.value);
  render(); updateUrl();
};
parallelSel.onchange = async function(){
  parallelBible = await loadFile(parallelSel.value);
  render();
};

/* FIRST RENDER */
render();

})();
</script>

</body>
</html>
